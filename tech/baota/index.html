<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>从0到1 用宝塔集成虚拟主机提供商 | Ken Blog</title>
<meta name="keywords" content="baota">
<meta name="description" content="前言 对比一般市场上的虚拟主机,宝塔都能兼容支持绝大多数的功能,并且宝塔有个比较大的特点为,页面上的接口均可以通过api请求,因此产生了这个想法定制出宝塔基础的虚拟主机
目标 前置条件 window server的主机
宝塔需安装在数据盘D盘上
正式内容 定义的配置文件 /data/vhost/baota.conf.json
[ { &#34;fchrServer&#34;:&#34;flage&#34;, &#34;host&#34;:&#34;127.0.0.1&#34;, &#34;key&#34;:&#34;bt_api_key&#34;, &#34;port&#34;:&#34;8888&#34;, &#34;mysql&#34;:&#34;mysql_password&#34;, &#34;sqlserver&#34;:&#34;mssql_password&#34;, &#34;region_id&#34;:&#34;hk&#34;, &#34;zone_id&#34;:&#34;hk-02&#34;, &#34;network&#34;:&#34;bgp&#34; } ] 封装好的交互php函数方法
class VhostBaotaClient implements VhostClientInterface { use ApiConfigTrait; use ApiLoggerTrait; private $client; private $key = &#34;&#34;; public $host = &#34;&#34;; private $port = &#34;8888&#34;; private $mssql_password = &#34;&#34;; /** * @var array 远端主机的状态转换 */ public $RemoteStatus = [ &#39;1&#39; =&gt; &#39;Running&#39;, &#39;0&#39; =&gt; &#39;Stopped&#39;, ]; public $IISRemoteStatus = [ &#39;Started&#39; =&gt; &#39;Running&#39;, &#39;Stopped&#39; =&gt; &#39;Stopped&#39;, ]; public static function getConfig() { return json_decode(file_get_contents(&#39;/data/vhost/baota.">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="/tech/baota/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4398b09e795c3aac93a04f4160281925a588bcdf14941ead87ab7bfe555ba854.css" integrity="sha256-Q5iwnnlcOqyToE9BYCgZJaWIvN8UlB6th6t7/lVbqFQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="从0到1 用宝塔集成虚拟主机提供商" />
<meta property="og:description" content="前言 对比一般市场上的虚拟主机,宝塔都能兼容支持绝大多数的功能,并且宝塔有个比较大的特点为,页面上的接口均可以通过api请求,因此产生了这个想法定制出宝塔基础的虚拟主机
目标 前置条件 window server的主机
宝塔需安装在数据盘D盘上
正式内容 定义的配置文件 /data/vhost/baota.conf.json
[ { &#34;fchrServer&#34;:&#34;flage&#34;, &#34;host&#34;:&#34;127.0.0.1&#34;, &#34;key&#34;:&#34;bt_api_key&#34;, &#34;port&#34;:&#34;8888&#34;, &#34;mysql&#34;:&#34;mysql_password&#34;, &#34;sqlserver&#34;:&#34;mssql_password&#34;, &#34;region_id&#34;:&#34;hk&#34;, &#34;zone_id&#34;:&#34;hk-02&#34;, &#34;network&#34;:&#34;bgp&#34; } ] 封装好的交互php函数方法
class VhostBaotaClient implements VhostClientInterface { use ApiConfigTrait; use ApiLoggerTrait; private $client; private $key = &#34;&#34;; public $host = &#34;&#34;; private $port = &#34;8888&#34;; private $mssql_password = &#34;&#34;; /** * @var array 远端主机的状态转换 */ public $RemoteStatus = [ &#39;1&#39; =&gt; &#39;Running&#39;, &#39;0&#39; =&gt; &#39;Stopped&#39;, ]; public $IISRemoteStatus = [ &#39;Started&#39; =&gt; &#39;Running&#39;, &#39;Stopped&#39; =&gt; &#39;Stopped&#39;, ]; public static function getConfig() { return json_decode(file_get_contents(&#39;/data/vhost/baota." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tech/baota/" /><meta property="og:image" content="/papermod-cover.png"/><meta property="article:section" content="tech" />
<meta property="article:published_time" content="2022-08-12T16:55:00&#43;08:00" />
<meta property="article:modified_time" content="2022-08-12T16:55:00&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/papermod-cover.png"/>

<meta name="twitter:title" content="从0到1 用宝塔集成虚拟主机提供商"/>
<meta name="twitter:description" content="前言 对比一般市场上的虚拟主机,宝塔都能兼容支持绝大多数的功能,并且宝塔有个比较大的特点为,页面上的接口均可以通过api请求,因此产生了这个想法定制出宝塔基础的虚拟主机
目标 前置条件 window server的主机
宝塔需安装在数据盘D盘上
正式内容 定义的配置文件 /data/vhost/baota.conf.json
[ { &#34;fchrServer&#34;:&#34;flage&#34;, &#34;host&#34;:&#34;127.0.0.1&#34;, &#34;key&#34;:&#34;bt_api_key&#34;, &#34;port&#34;:&#34;8888&#34;, &#34;mysql&#34;:&#34;mysql_password&#34;, &#34;sqlserver&#34;:&#34;mssql_password&#34;, &#34;region_id&#34;:&#34;hk&#34;, &#34;zone_id&#34;:&#34;hk-02&#34;, &#34;network&#34;:&#34;bgp&#34; } ] 封装好的交互php函数方法
class VhostBaotaClient implements VhostClientInterface { use ApiConfigTrait; use ApiLoggerTrait; private $client; private $key = &#34;&#34;; public $host = &#34;&#34;; private $port = &#34;8888&#34;; private $mssql_password = &#34;&#34;; /** * @var array 远端主机的状态转换 */ public $RemoteStatus = [ &#39;1&#39; =&gt; &#39;Running&#39;, &#39;0&#39; =&gt; &#39;Stopped&#39;, ]; public $IISRemoteStatus = [ &#39;Started&#39; =&gt; &#39;Running&#39;, &#39;Stopped&#39; =&gt; &#39;Stopped&#39;, ]; public static function getConfig() { return json_decode(file_get_contents(&#39;/data/vhost/baota."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Teches",
      "item": "/tech/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "从0到1 用宝塔集成虚拟主机提供商",
      "item": "/tech/baota/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "从0到1 用宝塔集成虚拟主机提供商",
  "name": "从0到1 用宝塔集成虚拟主机提供商",
  "description": "前言 对比一般市场上的虚拟主机,宝塔都能兼容支持绝大多数的功能,并且宝塔有个比较大的特点为,页面上的接口均可以通过api请求,因此产生了这个想法定制出宝塔基础的虚拟主机\n目标 前置条件 window server的主机\n宝塔需安装在数据盘D盘上\n正式内容 定义的配置文件 /data/vhost/baota.conf.json\n[ { \u0026#34;fchrServer\u0026#34;:\u0026#34;flage\u0026#34;, \u0026#34;host\u0026#34;:\u0026#34;127.0.0.1\u0026#34;, \u0026#34;key\u0026#34;:\u0026#34;bt_api_key\u0026#34;, \u0026#34;port\u0026#34;:\u0026#34;8888\u0026#34;, \u0026#34;mysql\u0026#34;:\u0026#34;mysql_password\u0026#34;, \u0026#34;sqlserver\u0026#34;:\u0026#34;mssql_password\u0026#34;, \u0026#34;region_id\u0026#34;:\u0026#34;hk\u0026#34;, \u0026#34;zone_id\u0026#34;:\u0026#34;hk-02\u0026#34;, \u0026#34;network\u0026#34;:\u0026#34;bgp\u0026#34; } ] 封装好的交互php函数方法\nclass VhostBaotaClient implements VhostClientInterface { use ApiConfigTrait; use ApiLoggerTrait; private $client; private $key = \u0026#34;\u0026#34;; public $host = \u0026#34;\u0026#34;; private $port = \u0026#34;8888\u0026#34;; private $mssql_password = \u0026#34;\u0026#34;; /** * @var array 远端主机的状态转换 */ public $RemoteStatus = [ \u0026#39;1\u0026#39; =\u0026gt; \u0026#39;Running\u0026#39;, \u0026#39;0\u0026#39; =\u0026gt; \u0026#39;Stopped\u0026#39;, ]; public $IISRemoteStatus = [ \u0026#39;Started\u0026#39; =\u0026gt; \u0026#39;Running\u0026#39;, \u0026#39;Stopped\u0026#39; =\u0026gt; \u0026#39;Stopped\u0026#39;, ]; public static function getConfig() { return json_decode(file_get_contents(\u0026#39;/data/vhost/baota.",
  "keywords": [
    "baota"
  ],
  "articleBody": "前言 对比一般市场上的虚拟主机,宝塔都能兼容支持绝大多数的功能,并且宝塔有个比较大的特点为,页面上的接口均可以通过api请求,因此产生了这个想法定制出宝塔基础的虚拟主机\n目标 前置条件 window server的主机\n宝塔需安装在数据盘D盘上\n正式内容 定义的配置文件 /data/vhost/baota.conf.json\n[ { \"fchrServer\":\"flage\", \"host\":\"127.0.0.1\", \"key\":\"bt_api_key\", \"port\":\"8888\", \"mysql\":\"mysql_password\", \"sqlserver\":\"mssql_password\", \"region_id\":\"hk\", \"zone_id\":\"hk-02\", \"network\":\"bgp\" } ] 封装好的交互php函数方法\nclass VhostBaotaClient implements VhostClientInterface { use ApiConfigTrait; use ApiLoggerTrait; private $client; private $key = \"\"; public $host = \"\"; private $port = \"8888\"; private $mssql_password = \"\"; /** * @var array 远端主机的状态转换 */ public $RemoteStatus = [ '1' =\u003e 'Running', '0' =\u003e 'Stopped', ]; public $IISRemoteStatus = [ 'Started' =\u003e 'Running', 'Stopped' =\u003e 'Stopped', ]; public static function getConfig() { return json_decode(file_get_contents('/data/vhost/baota.conf.json'), 1); } public function __construct($chrFTPServer = \"\") { if ($chrFTPServer) { $config = self::getConfig(); preg_match(\"([\\d]+)\", $chrFTPServer, $matches); foreach ($config as $value) { if ($value['fchrServer'] == $matches[0]) { $this-\u003ekey = $value['key']; $this-\u003ehost = $value['host']; $this-\u003eport = $value['port']; $this-\u003emssql_password = $value['sqlserver']; break; } } } $this-\u003einitLogger(-3, 2); $this-\u003eclient = new GuzzleHttp\\Client([ 'timeout' =\u003e 300.0, ]); } public function SetChrFTPServer($chrFTPServer = \"\") { if ($chrFTPServer) { $config = self::getConfig(); preg_match(\"([\\d]+)\", $chrFTPServer, $matches); foreach ($config as $value) { if ($value['fchrServer'] == $matches[0]) { $this-\u003ekey = $value['key']; $this-\u003ehost = $value['host']; $this-\u003eport = $value['port']; $this-\u003emssql_password = $value['sqlserver']; break; } } } } /** * 获取vhost实例远程信息 * @param array $ids 主参数，实例列表数组 * @param array $params 其它参数 * @return mixed */ public function describeInstances($ids = [], $params = []) { $action = '/data?action=getData'; $p = [ 'table' =\u003e 'sites', 'type' =\u003e -1, 'limit' =\u003e 20, 'p' =\u003e 1, 'search' =\u003e $ids[0] ]; return $this-\u003erequest($action, $p); } public function describePrice($vhost, $Period, $PeriodUnit) { // TODO: Implement describePrice() method. } public function describeRenewPrice($vhost, $Period, $PeriodUnit) { // TODO: Implement describeRenewPrice() method. } /** * 登陆第三方的控制平台 * @param $ecs * @return mixed */ public function describeControlPanel($vhost) { // TODO: Implement describeControlPanel() method. } /** * 登陆第三方的数据库控制平台 * @param $ecs * @return mixed */ public function describeDatabasePanel($vhost, $param = []) { $action = \"/files?action=GetDirList\"; $p = [ 'p' =\u003e 1, 'showRow' =\u003e 100, 'path' =\u003e 'D:/BtSoft/phpmyadmin', 'is_operating' =\u003e true, ]; $resp = $this-\u003erequest($action, $p); $filename = \"\"; foreach ($resp['LIST'] as $item) { if (stripos($item['filename'], \"phpmyadmin\") !== false) { $filename = $item['filename']; } }; return [ 'content' =\u003e \"http://{$this-\u003ehost}:888/{$filename}\", 'type' =\u003e 'url', ]; } /** * 查询可使用的数据库 * @param $vhost * @return mixed */ public function DescribeDatabase($vhost) { // TODO: Implement DescribeDatabase() method. } /** * 修改密码 * @param $vhost * @param $password * @return mixed */ public function ModifyInstancePasswd($vhost, $password) { $ftp_resp = $this-\u003eGetData(\"ftps\", $vhost['chrDomain']); $action = \"/ftp?action=SetUserPassword\"; $p = [ 'id' =\u003e $ftp_resp['data'][0]['id'], 'ftp_username' =\u003e $vhost['UserName'], 'new_password' =\u003e $password, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } /** * 更换数据库 * @param $vhost * @param array $param * @return mixed */ public function ExchangeDatabase($vhost, $param = []) { // TODO: Implement ExchangeDatabase() method. } /** * 更换服务器 * @param $vhost * @param array $param * @return mixed */ public function ExchangeInstance($vhost, $param = []) { // TODO: Implement ExchangeInstance() method. } /** * 域名绑定 * @param $vhost * @param $domain * @return mixed */ public function BindDomain($vhost, $domain) { $action = \"/site?action=AddDomain\"; $p = [ 'domain' =\u003e $domain, 'webname' =\u003e $vhost['chrDomain'], 'id' =\u003e $vhost['remoteID'], ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); if($resp['status'] === true){ return true; }elseif (stripos($resp['msg'], \"指定域名已绑定过\") !== false){ // 判断 已绑定的域名是否和当前主机id一致 $GetData = $this-\u003eGetData('sites', $domain); if($GetData['data']\u0026\u0026$GetData['data'][0]['id']==$vhost['remoteID']){ return true; } } return $resp['msg']; } public function sign($params) { $now_time = time(); $sign = [ 'request_token' =\u003e md5($now_time . '' . md5($this-\u003ekey)), 'request_time' =\u003e $now_time ]; return array_merge($params, $sign); } public function request($action, $params = []) { $query = $this-\u003esign($params); try { $resp = $this-\u003eclient-\u003erequest('POST', \"http://{$this-\u003ehost}:{$this-\u003eport}/{$action}\", ['form_params' =\u003e $query, 'verify' =\u003e false,]); $content = $resp-\u003egetBody()-\u003egetContents(); return json_decode($content, 1) !== null ? json_decode($content, 1) : $content; } catch (\\Exception $e) { return ['status' =\u003e 'failed', 'message' =\u003e 'remote api error' . $e-\u003egetMessage()]; } } /** * 创建实例 * \\panel\\data\\defaultDoc.html * @param $vhost * @param $Period * @param $PeriodUnit * @param bool $DryRun * @return mixed */ public function CreateInstance($vhost, $Period, $PeriodUnit, $DryRun = false) { $versionInfo = $this-\u003eDescribePHPVersion(); $product = Product::find($vhost['fIDProd']); $version = $versionInfo[count($versionInfo) - 1]['version']; $type = \"PHP\"; $systeminfo = $this-\u003eGetSystemTotal(); if (stripos($systeminfo['system'], \"centos\") !== false) { $basePath = \"/www/wwwroot/\"; } else { $basePath = \"D:/\"; } $path = \"{$basePath}{$product['Space']}/{$vhost['chrDomain']}\"; $datauser = $vhost['UserName']; $datapassword = $vhost['Password']; $database = VhostDB::whereIn('fIDIDProd', [\"h{$vhost['IDVHost']}\", \"ch{$vhost['IDVHost']}\"]) -\u003ewith(['product']) -\u003efirst(); if ($database \u0026\u0026 preg_match(\"/mysql/i\", $database['product']['chrScript'])) { $datauser = $database['DBLogin']; $datapassword = $database['Password'] ? $database['Password'] : $vhost['Password']; } $p = [ 'webname' =\u003e json_encode(['domain' =\u003e $vhost['chrDomain'], 'domainlist' =\u003e [], 'count' =\u003e 0], JSON_UNESCAPED_UNICODE), 'check_dir' =\u003e 1, 'path' =\u003e $path, 'type_id' =\u003e 0, 'type' =\u003e $type, //Asp Php 'port' =\u003e '80', 'ftp' =\u003e 'true', 'ftp_username' =\u003e $vhost['UserName'], 'ftp_password' =\u003e $vhost['Password'], 'sql' =\u003e 'true', // 'sql' =\u003e 'SQLServer', 'codeing' =\u003e 'utf8mb4', 'datauser' =\u003e $datauser, 'datapassword' =\u003e $datapassword, 'version' =\u003e $version, 'ps' =\u003e $vhost['UserName'], ]; $action = \"/site?action=AddSite\"; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); if (isset($resp['status']) \u0026\u0026 !$resp['status']) return $resp['msg']; // 设置过期时间 $p = [ 'id' =\u003e $resp['siteId'], 'edate' =\u003e date(\"Y-m-d\", strtotime($vhost['dtExpired'])), ]; $this-\u003erequest(\"/site?action=SetEdate\", $p); //设置数据库可全部人访问 $p = [ 'name' =\u003e $vhost['UserName'], 'dataAccess' =\u003e '%', 'access' =\u003e '%', ]; $this-\u003erequest(\"/database?action=SetDatabaseAccess\", $p); $this-\u003eChangePHPVersion($vhost, $version); return $resp; } /** * 开机 * @return mixed */ public function StartInstance($vhost) { $action = \"/site?action=SiteStart\"; $p = [ 'id' =\u003e $vhost['remoteID'], 'name' =\u003e $vhost['chrDomain'] ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } /** * 关机 * @return mixed */ public function StopInstance($vhost) { $action = \"/site?action=SiteStop\"; $p = [ 'id' =\u003e $vhost['remoteID'], 'name' =\u003e $vhost['chrDomain'] ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function GetData($table, $search = \"\", $p = 1, $limit = 20, $type = null) { $action = \"/data?action=getData\"; $p = [ 'table' =\u003e $table, 'search' =\u003e $search, 'p' =\u003e $p, 'limit' =\u003e $limit, ]; if ($type !== null) { $p['type'] = $type; } $resp = $this-\u003erequest($action, $p); return $resp['data'] \u0026\u0026 is_array($resp['data']) ? $resp : $resp['data']; } /** * 修改数据库密码 * @param $vhost * @param $password * @return mixed */ public function ModifyDatabasePasswd($vhost, $password, $param = []) { $data_resp = $this-\u003eGetData(\"databases\", $vhost['UserName']); $action = \"/database?action=ResDatabasePassword\"; $p = [ 'id' =\u003e $data_resp['data'][0]['id'], 'name' =\u003e $vhost['UserName'], 'password' =\u003e $password, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function upgradeInstance($vhost, $param = []) { $systeminfo = $this-\u003eGetSystemTotal(); $product = Product::find($vhost['fIDProd']); $newProduct = Product::find($param['new_product_id']); if (stripos($systeminfo['system'], \"centos\") !== false) { $basePath = \"/www/wwwroot/\"; } else { $basePath = \"D:/\"; } //检查文件夹是否存在 $action = \"/files?action=CheckExistsFiles\"; $p = [ 'dfile' =\u003e \"{$basePath}{$newProduct['Space']}\", 'filename' =\u003e $vhost['chrDomain'] ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); if (empty($resp)) { //目标不存在进行复制项目文件夹 $action = \"/files?action=CopyFile\"; $p = [ 'sfile' =\u003e \"{$basePath}{$product['Space']}/{$vhost['chrDomain']}\", 'dfile' =\u003e \"{$basePath}{$newProduct['Space']}/{$vhost['chrDomain']}\", ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); if ($resp['status'] !== true) return $resp['msg']; sleep(3); } $action = \"/site?action=SetPath\"; $p = [ 'id' =\u003e strval($vhost['remoteID']), 'path' =\u003e \"{$basePath}{$newProduct['Space']}/{$vhost['chrDomain']}\", ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); sleep(2); $ftpArray = $this-\u003eGetData(\"ftps\", $vhost['UserName']); if(empty($ftpArray)||$ftpArray['data'][0]['path']!=\"{$basePath}{$newProduct['Space']}/{$vhost['chrDomain']}\"){ //删除原来的ftp账号 $ftp_remote_id = $ftpArray['data'][0]['id']; $action = \"/ftp?action=DeleteUser\"; $p = [ 'id' =\u003e strval($ftp_remote_id), 'username' =\u003e $vhost['UserName'], ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); sleep(2); //切换ftp $action = \"/ftp?action=AddUser\"; $p = [ 'ftp_username' =\u003e strval($vhost['UserName']), 'ftp_password' =\u003e strval($vhost['Password']), 'path' =\u003e \"{$basePath}{$newProduct['Space']}/{$vhost['chrDomain']}\", 'ps' =\u003e $vhost['UserName'], ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); } return $resp['status'] === true || $resp['msg'] == '与原路径一致，无需修改!' ? true : $resp['msg']; } /** * 续费实例 * @param $vhost * @param $Period * @param $PeriodUnit * @return mixed */ public function RenewInstance($vhost, $Period, $PeriodUnit) { $action = \"/site?action=SetEdate\"; // 设置过期时间 $p = [ 'id' =\u003e $vhost['remoteID'], 'edate' =\u003e date(\"Y-m-d\", strtotime(\"{$vhost['dtExpired']} + {$Period} {$PeriodUnit}\")), ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); if ($resp['status'] === true) { $this-\u003eStartInstance($vhost); } return $resp['status'] === true ? true : $resp['msg']; } public function GetSystemTotal() { $action = \"/system?action=GetSystemTotal\"; $resp = $this-\u003erequest($action); return $resp; } public function GetSystemConfig() { $action = \"/config?action=get_config\"; $resp = $this-\u003erequest($action); return $resp; } public function DescribePHPVersion() { $action = \"/site?action=GetPHPVersion\"; $resp = $this-\u003erequest($action); $data = []; foreach ($resp as $item) { if ($item['version'] \u003e 0) { $data[] = [ 'version' =\u003e $item['version'], 'name' =\u003e $item['name'], ]; } } return $data; } public function GetPHPVersion($vhost) { $action = \"/site?action=GetSitePHPVersion\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'] ]; $resp = $this-\u003erequest($action, $p); return ['Version' =\u003e $resp['phpversion']]; } public function ChangePHPVersion($vhost, $version) { $action = \"/site?action=SetPHPVersion\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'], 'version' =\u003e $version, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } /** * 域名解绑 * @param $vhost * @param $domain * @return mixed */ public function RemoveBindDomain($vhost, $domain) { $action = \"/site?action=DelDomain\"; $p = [ 'domain' =\u003e $domain, 'webname' =\u003e $vhost['chrDomain'], 'id' =\u003e $vhost['remoteID'], 'port' =\u003e 80, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function GetIndex($vhost) { $action = \"/site?action=GetIndex\"; $p = [ 'id' =\u003e $vhost['remoteID'], ]; $resp = $this-\u003erequest($action, $p); return explode(\",\", $resp); } public function SetIndex($vhost, $indexArray = []) { $action = \"/site?action=SetIndex\"; $p = [ 'id' =\u003e $vhost['remoteID'], 'Index' =\u003e implode(\",\", $indexArray) ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function CreateBackup($vhost) { $DescribeBackup = $this-\u003eDescribeBackup($vhost); if (count($DescribeBackup) \u003e= 5) { return \"count.limit\"; } $action = \"/site?action=ToBackup\"; $p = [ 'id' =\u003e $vhost['remoteID'] ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function DescribeBackup($vhost, $param = []) { $GetSystemConfig = $this-\u003eGetSystemConfig(); $action = \"/files?action=GetDirList\"; $p = [ 'p' =\u003e 1, 'showRow' =\u003e 100, 'path' =\u003e \"{$GetSystemConfig['backup_path']}/site\", 'search' =\u003e $vhost['chrDomain'], ]; $resp = $this-\u003erequest($action, $p); $data = []; foreach ($resp['LIST'] as $item) { if (!$item['down_id']) { $action = \"/files?action=create_download_url\"; $p = [ 'filename' =\u003e \"{$GetSystemConfig['backup_path']}/site/{$item['filename']}\", 'ps' =\u003e $item['filename'], 'password' =\u003e '', 'expire' =\u003e 1130800, ]; $create_download = $this-\u003erequest($action, $p); $down_id = $create_download['msg']['id']; } else { $down_id = $item['down_id']; } $get_download_url_find = $this-\u003erequest(\"/files?action=get_download_url_find\", [ 'id' =\u003e $down_id, ]); $data[] = [ 'id' =\u003e $item['id'], 'filename' =\u003e $item['filename'], 'created_at' =\u003e date(\"Y-m-d H:i:s\", $item['mtime']), 'size' =\u003e $item['size'], 'url' =\u003e \"http://{$this-\u003ehost}:8888/down/{$get_download_url_find['token']}\" ]; } return $data; } public function RemoveBackup($vhost, $filename, $param = []) { $backup_remote_id = 0; $DataArray = $this-\u003eGetData('backup', $vhost['remoteID'], 1, 20, 0); foreach ($DataArray['data'] as $item) { if ($filename == $item['name']) { $backup_remote_id = $item['id']; break; } } if (!$backup_remote_id) { return true; } $action = \"/site?action=DelBackup\"; $p = [ 'id' =\u003e $backup_remote_id ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function DescribeAccessLog($vhost, $param = []) { $action = \"/site?action=GetSiteLogs\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'], ]; $resp = $this-\u003erequest($action, $p); if (!$resp['status']) { return $resp['msg']; } $action = \"/files?action=GetDirList\"; $p = [ 'p' =\u003e 1, 'showRow' =\u003e 100, 'path' =\u003e $resp['path'], 'is_operating' =\u003e true, ]; $fileResp = $this-\u003erequest($action, $p); $data = []; foreach ($fileResp['LIST'] as $item) { $data[] = [ 'name' =\u003e $item['filename'], ]; } return [ 'Content' =\u003e $resp['msg'] ]; } public function DownloadAccessLog($vhost, $param = []) { //获取文件夹位置 $action = \"/site?action=GetSiteLogs\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'], ]; $resp = $this-\u003erequest($action, $p); if (!$resp['status']) { return $resp['msg']; } $fileArray = explode(\"/\", $resp['path']); $sfile = array_pop($fileArray); $basePath = implode(\"/\", $fileArray); // //删除文件 // $action = \"/files?action=DeleteFile\"; // $p = [ // 'path' =\u003e \"{$basePath}/{$sfile}.zip\" // ]; // $this-\u003erequest($action, $p); //压缩文件 $action = \"/files?action=Zip\"; $p = [ 'sfile' =\u003e $sfile, 'dfile' =\u003e \"{$basePath}/{$sfile}.zip\", 'z_type' =\u003e 'zip', 'path' =\u003e \"{$basePath}/\", ]; $resp = $this-\u003erequest($action, $p); if (!$resp['status']) return $resp['msg']; $action = \"/files?action=GetDirList\"; $p = [ 'p' =\u003e 1, 'showRow' =\u003e 100, 'path' =\u003e $basePath, 'search' =\u003e \"{$sfile}.zip\", ]; $resp = $this-\u003erequest($action, $p); if (isset($resp[\"LIST\"]) \u0026\u0026 count($resp[\"LIST\"]) \u003e 0 \u0026\u0026 $resp[\"LIST\"][0]['down_id']) { $get_download_url_find = $this-\u003erequest(\"/files?action=get_download_url_find\", [ 'id' =\u003e $resp[\"LIST\"][0]['down_id'], ]); $token = $get_download_url_find['token']; } else { //生成外链 $action = \"/files?action=create_download_url\"; $p = [ 'filename' =\u003e \"{$basePath}/{$sfile}.zip\", 'ps' =\u003e \"{$sfile}.zip\", 'password' =\u003e '', 'expire' =\u003e 1130800, ]; $create_download_url = $this-\u003erequest($action, $p); $token = $create_download_url['msg']['token']; } return [ 'type' =\u003e 'url', 'Content' =\u003e \"http://{$this-\u003ehost}:{$this-\u003eport}/down/{$token}\", ]; } public function DescribeNetVersion($vhost) { $action = \"/site?action=get_iis_net_versions\"; $resp = $this-\u003erequest($action); return $resp; } public function ModifyNetVersion($vhost, $version, $param = []) { $action = \"/site?action=set_iis_apppool\"; $p = [ 'model' =\u003e 'Integrated', // Integrated 集成 Classic 经典 'net_version' =\u003e \"{$version}\", 'enable32BitAppOnWin64' =\u003e \"true\", 'queueLength' =\u003e \"10000\", 'name' =\u003e $vhost['chrDomain'], ]; if (isset($param['Model']) \u0026\u0026 $param['Model']) { $p['model'] = $param['Model']; } $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); return $resp['status'] === true ? true : $resp['msg']; } public function GetNetConfig($vhost) { $action = \"/site?action=get_net_version_byaspp\"; $p = [ 'name' =\u003e $vhost['chrDomain'] ]; return $this-\u003erequest($action, $p); } public function ChangeApppoolStatus($vhost, $status) { $action = \"/site?action=set_apppool_status\"; $p = [ 'name' =\u003e $vhost['chrDomain'], 'status' =\u003e $status, ]; $logID = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $resp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID, $resp); return $resp['status'] === true ? true : $resp['msg']; } public function GetRewriteList($vhost) { $action = \"/site?action=GetRewriteList\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'] ]; $resp = $this-\u003erequest($action, $p); $data = []; foreach ($resp[\"rewrite\"] as $item) { $data[] = $item == '0.当前' ? 'self' : $item; } return $data; } public function GetFileBody($vhost, $template) { $systeminfo = $this-\u003eGetSystemTotal(); if (stripos($systeminfo['system'], \"centos\") !== false) { $basePath = \"/www/wwwroot/\"; } else { $basePath = \"D:/\"; } $action = \"/files?action=GetFileBody\"; $p = [ 'path' =\u003e \"{$basePath}/BtSoft/panel/rewrite/iis/{$template}.conf\" ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? [ 'content' =\u003e $resp['data'] ] : $resp['msg']; } public function GetSiteRewrite($vhost) { $action = \"/site?action=GetSiteRewrite\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'], ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? [ 'content' =\u003e $resp['data'] ] : $resp['msg']; } public function SetSiteRewrite($vhost, $content) { $action = \"/site?action=SetSiteRewrite\"; $p = [ 'siteName' =\u003e $vhost['chrDomain'], 'data' =\u003e $content, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function DescribeSiteErrorPages($vhost) { $action = \"/site?action=get_site_error_pages\"; $p = [ 'name' =\u003e $vhost['chrDomain'], ]; $resp = $this-\u003erequest($action, $p); $data = []; foreach ($resp['list'] as $item) { $data[] = [ 'code' =\u003e $item['statusCode'], 'path' =\u003e $item['path'], 'mode' =\u003e $item['responseMode'] == 'File' ? 'default' : 'self' ]; } return $data; } public function SetErrorPage($vhost, $code, $path, $param = []) { if (stripos($path, \"%SystemDrive%\") !== false) { return \"path.error\"; } $action = \"/site?action=set_error_page_bycode\"; $p = [ 'code' =\u003e $code, 'responseMode' =\u003e 'ExecuteURL', 'path' =\u003e \"/{$path}\", 'name' =\u003e $vhost['chrDomain'] ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function ResetErrorPage($vhost, $code, $param = []) { $action = \"/site?action=re_error_page_bycode\"; $p = [ 'code' =\u003e $code, 'name' =\u003e $vhost['chrDomain'] ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function UnZip($vhost, $filename) { $action = \"/files?action=UnZip\"; $p = [ 'sfile' =\u003e \"D:/{$vhost['Quota']}/{$vhost['chrDomain']}/{$filename}\", 'dfile' =\u003e \"D:/{$vhost['Quota']}/{$vhost['chrDomain']}\", 'type' =\u003e \"zip\", 'coding' =\u003e \"UTF-8\", ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function GetNetWork() { $action = \"/system?action=GetNetWork\"; return $this-\u003erequest($action); } public function StartFtp($vhost) { $GetData = $this-\u003eGetData('ftps', $vhost['UserName']); $action = \"/ftp?action=SetStatus\"; $p = [ 'id' =\u003e $GetData['data'][0]['id'], 'username' =\u003e $vhost['UserName'], 'status' =\u003e 1, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function StopFtp($vhost) { $GetData = $this-\u003eGetData('ftps', $vhost['UserName']); $action = \"/ftp?action=SetStatus\"; $p = [ 'id' =\u003e $GetData['data'][0]['id'], 'username' =\u003e $vhost['UserName'], 'status' =\u003e 0, ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } private function get_mssql_row($database, $query) { $dbcfg = [ 'server' =\u003e $this-\u003ehost, 'username' =\u003e 'sa', 'password' =\u003e $this-\u003emssql_password, 'database' =\u003e 'master', ]; if (function_exists('mssql_connect')) { $link = @mssql_connect($dbcfg['server'], $dbcfg['username'], $dbcfg['password']); mssql_select_db($dbcfg['database'], $link); $res = @mssql_query($query, $link); $row = @mssql_fetch_assoc($res); mssql_free_result($res); @mssql_close($link); } elseif (function_exists('odbc_pconnect')) { $conn = odbc_pconnect(\"Driver={ODBC Driver 17 for SQL Server};Server={$dbcfg['server']};DataBase={$dbcfg['database']}\", $dbcfg['username'], $dbcfg['password']); $result = odbc_exec($conn, $query); $row = odbc_fetch_array($result); odbc_close($conn); } elseif (function_exists('sqlsrv_connect')) { $connectionInfo = array(\"Database\" =\u003e $dbcfg['database'], \"UID\" =\u003e $dbcfg['username'], \"PWD\" =\u003e $dbcfg['password']); $link = sqlsrv_connect($dbcfg['server'], $connectionInfo); $result = sqlsrv_query($link, $query); $row = sqlsrv_fetch_array($result, SQLSRV_FETCH_ASSOC); sqlsrv_close($link); } else { $host = \"sqlsrv:Server=\" . str_replace(\":\", \",\", $dbcfg['server']) . \";Database=\" . $dbcfg['database'] . \";\"; $obj = new PDO($host, $dbcfg['username'], $dbcfg['password']); $row = []; foreach ($obj-\u003equery($query) as $val) { $row = $val; break; } } return $row; } /** * 创建数据库 */ public function AddDatabase($vhost, $siteId) { $datauser = \"{$vhost['UserName']}_ms\"; $datapassword = $vhost['Password']; $database = VhostDB::whereIn('fIDIDProd', [\"h{$vhost['IDVHost']}\", \"ch{$vhost['IDVHost']}\"]) -\u003ewith(['product']) -\u003efirst(); if ($database \u0026\u0026 !preg_match(\"/mysql/i\", $database['product']['chrScript'])) { $datauser = $database['DBLogin']; $datapassword = $database['Password'] ? $database['Password'] : $vhost['Password']; } //数据库不能字母开头,如果迁移后的ftp是数字开通的,更换一下数据库名 if (intval($datauser[0]) \u003e 0) { $datauser = \"h{$datauser}\"; } $action = \"/database?action=AddDatabase\"; $p = [ 'name' =\u003e $datauser, 'codeing' =\u003e \"utf8\", 'db_user' =\u003e $datauser, 'password' =\u003e $datapassword, 'dtype' =\u003e 'SQLServer', 'contact' =\u003e $siteId, 'dataAccess' =\u003e '127.0.0.1', 'address' =\u003e '127.0.0.1', 'ps' =\u003e $datauser, ]; $logID_AddDatabase = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $AddDatabaseResp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID_AddDatabase, $AddDatabaseResp); if ($AddDatabaseResp['status'] === true) { try { $this-\u003eget_mssql_row(\"{$vhost['UserName']}_ms\", \"ALTER DATABASE [{$vhost['UserName']}_ms] MODIFY FILE ( NAME = N'{$vhost['UserName']}_ms', MAXSIZE = 100MB )\"); } catch (\\Throwable $e) { WebLog::log(\"{$vhost['UserName']} 修改mssql容量失败:\" . $e-\u003egetMessage()); } } return $AddDatabaseResp['status'] === true ? true : $AddDatabaseResp['msg']; } public function BatchRemoveCrontab($vhost) { $action = \"/crontab?action=GetCrontab\"; $p = [ 'page' =\u003e 1, ]; $CrontabList = $this-\u003erequest($action, $p); foreach ($CrontabList as $crontab) { if ($crontab['sType'] == 'database' \u0026\u0026 in_array($crontab['sName'], [\"{$vhost['UserName']}_ms\", $vhost['UserName']])) { $this-\u003eRemoveCrontab(['id' =\u003e $crontab]); } elseif ($crontab['sType'] == 'site' \u0026\u0026 $crontab['sName'] == $vhost['chrDomain']) { $this-\u003eRemoveCrontab(['id' =\u003e $crontab]); } } } public function RemoveCrontab($crontab) { $action = \"/crontab?action=DelCrontab\"; $p = [ 'id' =\u003e $crontab['id'], ]; $resp = $this-\u003erequest($action, $p); return $resp['status'] === true ? true : $resp['msg']; } public function BatchAddCrontab($vhost) { //创建计划任务定时备份 $action = \"/crontab?action=AddCrontab\"; $p = [ 'sType' =\u003e 'site', 'name' =\u003e \"备份网站[{$vhost['chrDomain']}]\", 'type' =\u003e 'day', 'hour' =\u003e 1, 'minute' =\u003e 30, 'sName' =\u003e $vhost['chrDomain'], 'backupTo' =\u003e 'localhost', 'save' =\u003e 3, 'sBody' =\u003e '', ]; $logID_AddCrontab = $this-\u003elogRequest(array_merge($p, ['action' =\u003e $action])); $AddCrontabResp = $this-\u003erequest($action, $p); $this-\u003elogResponse($logID_AddCrontab, $AddCrontabResp); $databaseList = VhostDB::whereIn('fIDIDProd', [\"h{$vhost['IDVHost']}\", \"ch{$vhost['IDVHost']}\"]) -\u003ewith(['product']) -\u003eget(); $mysql_sName = $vhost['UserName']; $mssql_sName = \"{$vhost['UserName']}_ms\"; foreach ($databaseList as $database) { if (preg_match(\"/mysql/i\", $database['product']['chrScript'])) { $mysql_sName = $database['DBLogin']; } else { $mssql_sName = $database['DBLogin']; } } $p = [ 'sType' =\u003e 'database', 'name' =\u003e \"备份数据库[{$vhost['UserName']}]\", 'type' =\u003e 'day', 'hour' =\u003e 2, 'minute' =\u003e 30, 'sName' =\u003e $mysql_sName, 'backupTo' =\u003e 'localhost', 'save' =\u003e 3, 'sBody' =\u003e '', ]; $this-\u003erequest($action, $p); $p = [ 'sType' =\u003e 'database', 'name' =\u003e \"备份数据库[{$vhost['UserName']}_ms]\", 'type' =\u003e 'day', 'hour' =\u003e 2, 'minute' =\u003e 30, 'sName' =\u003e $mssql_sName, 'backupTo' =\u003e 'localhost', 'save' =\u003e 3, 'sBody' =\u003e '', ]; $this-\u003erequest($action, $p); } public function DescribeInstanceMonitorData($vhost, $param = []) { $action = \"/files?action=get_path_size\"; $p = [ 'path' =\u003e \"D:/{$vhost['Quota']}/{$vhost['chrDomain']}\", ]; $sizeResp = $this-\u003erequest($action, $p); return [ 'Size' =\u003e $sizeResp['size'] ]; } } window 版 安装宝塔至d盘 打开服务器管理器-\u003e添加角色和功能-\u003e服务器角色-\u003e文件和存储服务-\u003e文件和ISCSI服务-\u003e文件服务器资源管理器 打开文件服務器資源管理器\n",
  "wordCount" : "3038",
  "inLanguage": "zh",
  "datePublished": "2022-08-12T16:55:00+08:00",
  "dateModified": "2022-08-12T16:55:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/tech/baota/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ken Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Ken Blog (Alt + H)">Ken Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs"><a href="/">主页</a>&nbsp;»&nbsp;<a href="/tech/">Teches</a></div>
        <h1 class="post-title">
            从0到1 用宝塔集成虚拟主机提供商
        </h1>
        <div class="post-meta"><span title='2022-08-12 16:55:00 +0800 CST'>八月 12, 2022</span>&nbsp;·&nbsp;15 分钟&nbsp;·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/tech/baota.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
    </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                <li>
                    <a href="#%e7%9b%ae%e6%a0%87" aria-label="目标">目标</a></li>
                <li>
                    <a href="#%e5%89%8d%e7%bd%ae%e6%9d%a1%e4%bb%b6" aria-label="前置条件">前置条件</a></li>
                <li>
                    <a href="#%e6%ad%a3%e5%bc%8f%e5%86%85%e5%ae%b9" aria-label="正式内容">正式内容</a><ul>
                        <ul>
                        
                <li>
                    <a href="#%e5%ae%9a%e4%b9%89%e7%9a%84%e9%85%8d%e7%bd%ae%e6%96%87%e4%bb%b6" aria-label="定义的配置文件">定义的配置文件</a></li>
                <li>
                    <a href="#window-%e7%89%88" aria-label="window 版">window 版</a>
                </li>
            </ul>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

    <div class="post-content"><h2 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h2>
<p>对比一般市场上的虚拟主机,宝塔都能兼容支持绝大多数的功能,并且宝塔有个比较大的特点为,页面上的接口均可以通过api请求,因此产生了这个想法定制出宝塔基础的虚拟主机</p>
<h2 id="目标">目标<a hidden class="anchor" aria-hidden="true" href="#目标">#</a></h2>
<h2 id="前置条件">前置条件<a hidden class="anchor" aria-hidden="true" href="#前置条件">#</a></h2>
<p>window server的主机<br>
宝塔需安装在数据盘D盘上</p>
<h2 id="正式内容">正式内容<a hidden class="anchor" aria-hidden="true" href="#正式内容">#</a></h2>
<h4 id="定义的配置文件">定义的配置文件<a hidden class="anchor" aria-hidden="true" href="#定义的配置文件">#</a></h4>
<p>/data/vhost/baota.conf.json</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;fchrServer&#34;</span><span class="p">:</span><span class="s2">&#34;flage&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;host&#34;</span><span class="p">:</span><span class="s2">&#34;127.0.0.1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;key&#34;</span><span class="p">:</span><span class="s2">&#34;bt_api_key&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;port&#34;</span><span class="p">:</span><span class="s2">&#34;8888&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;mysql&#34;</span><span class="p">:</span><span class="s2">&#34;mysql_password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;sqlserver&#34;</span><span class="p">:</span><span class="s2">&#34;mssql_password&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;region_id&#34;</span><span class="p">:</span><span class="s2">&#34;hk&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;zone_id&#34;</span><span class="p">:</span><span class="s2">&#34;hk-02&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;network&#34;</span><span class="p">:</span><span class="s2">&#34;bgp&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>封装好的交互php函数方法</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-php" data-lang="php"><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">VhostBaotaClient</span> <span class="k">implements</span> <span class="nx">VhostClientInterface</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">use</span> <span class="nx">ApiConfigTrait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">use</span> <span class="nx">ApiLoggerTrait</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$client</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$key</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$host</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$port</span> <span class="o">=</span> <span class="s2">&#34;8888&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="nv">$mssql_password</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @var array  远端主机的状态转换
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$RemoteStatus</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;1&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Running&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;0&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Stopped&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="nv">$IISRemoteStatus</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Started&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Running&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;Stopped&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Stopped&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">getConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nx">file_get_contents</span><span class="p">(</span><span class="s1">&#39;/data/vhost/baota.conf.json&#39;</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$chrFTPServer</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$chrFTPServer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$config</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;([\d]+)&#34;</span><span class="p">,</span> <span class="nv">$chrFTPServer</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$config</span> <span class="k">as</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;fchrServer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">port</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mssql_password</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;sqlserver&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">initLogger</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">GuzzleHttp\Client</span><span class="p">([</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;timeout&#39;</span> <span class="o">=&gt;</span> <span class="mf">300.0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">]);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">SetChrFTPServer</span><span class="p">(</span><span class="nv">$chrFTPServer</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$chrFTPServer</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$config</span> <span class="o">=</span> <span class="nx">self</span><span class="o">::</span><span class="na">getConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;([\d]+)&#34;</span><span class="p">,</span> <span class="nv">$chrFTPServer</span><span class="p">,</span> <span class="nv">$matches</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$config</span> <span class="k">as</span> <span class="nv">$value</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;fchrServer&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$matches</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">port</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mssql_password</span> <span class="o">=</span> <span class="nv">$value</span><span class="p">[</span><span class="s1">&#39;sqlserver&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                    <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 获取vhost实例远程信息
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $ids 主参数，实例列表数组
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $params 其它参数
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">describeInstances</span><span class="p">(</span><span class="nv">$ids</span> <span class="o">=</span> <span class="p">[],</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s1">&#39;/data?action=getData&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;sites&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;search&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">describePrice</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$Period</span><span class="p">,</span> <span class="nv">$PeriodUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Implement describePrice() method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">describeRenewPrice</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$Period</span><span class="p">,</span> <span class="nv">$PeriodUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Implement describeRenewPrice() method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 登陆第三方的控制平台
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $ecs
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">describeControlPanel</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Implement describeControlPanel() method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 登陆第三方的数据库控制平台
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $ecs
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">describeDatabasePanel</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=GetDirList&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;showRow&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;D:/BtSoft/phpmyadmin&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;is_operating&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$filename</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;LIST&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span> <span class="s2">&#34;phpmyadmin&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$filename</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;http://</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">:888/</span><span class="si">{</span><span class="nv">$filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 查询可使用的数据库
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribeDatabase</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Implement DescribeDatabase() method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 修改密码
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $password
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ModifyInstancePasswd</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$ftp_resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s2">&#34;ftps&#34;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/ftp?action=SetUserPassword&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$ftp_resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;ftp_username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;new_password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 更换数据库
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $param
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ExchangeDatabase</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Implement ExchangeDatabase() method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 更换服务器
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param array $param
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ExchangeInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// TODO: Implement ExchangeInstance() method.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 域名绑定
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $domain
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">BindDomain</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$domain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=AddDomain&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;domain&#39;</span> <span class="o">=&gt;</span> <span class="nv">$domain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;webname&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span><span class="k">elseif</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">],</span> <span class="s2">&#34;指定域名已绑定过&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// 判断 已绑定的域名是否和当前主机id一致
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$GetData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s1">&#39;sites&#39;</span><span class="p">,</span> <span class="nv">$domain</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span><span class="p">(</span><span class="nv">$GetData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">&amp;&amp;</span><span class="nv">$GetData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">==</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">]){</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">sign</span><span class="p">(</span><span class="nv">$params</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$now_time</span> <span class="o">=</span> <span class="nx">time</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sign</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;request_token&#39;</span> <span class="o">=&gt;</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$now_time</span> <span class="o">.</span> <span class="s1">&#39;&#39;</span> <span class="o">.</span> <span class="nx">md5</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">key</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;request_time&#39;</span> <span class="o">=&gt;</span> <span class="nv">$now_time</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">array_merge</span><span class="p">(</span><span class="nv">$params</span><span class="p">,</span> <span class="nv">$sign</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$params</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">sign</span><span class="p">(</span><span class="nv">$params</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">client</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s2">&#34;http://</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">port</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$action</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;form_params&#39;</span> <span class="o">=&gt;</span> <span class="nv">$query</span><span class="p">,</span> <span class="s1">&#39;verify&#39;</span> <span class="o">=&gt;</span> <span class="k">false</span><span class="p">,]);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$content</span> <span class="o">=</span> <span class="nv">$resp</span><span class="o">-&gt;</span><span class="na">getBody</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getContents</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="k">null</span> <span class="o">?</span> <span class="nx">json_decode</span><span class="p">(</span><span class="nv">$content</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="nv">$content</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;failed&#39;</span><span class="p">,</span> <span class="s1">&#39;message&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;remote api error&#39;</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">()];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 创建实例
</span></span></span><span class="line"><span class="cl"><span class="sd">     * \panel\data\defaultDoc.html
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $Period
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $PeriodUnit
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param bool $DryRun
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">CreateInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$Period</span><span class="p">,</span> <span class="nv">$PeriodUnit</span><span class="p">,</span> <span class="nv">$DryRun</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$versionInfo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">DescribePHPVersion</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;fIDProd&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$version</span> <span class="o">=</span> <span class="nv">$versionInfo</span><span class="p">[</span><span class="nx">count</span><span class="p">(</span><span class="nv">$versionInfo</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">][</span><span class="s1">&#39;version&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$type</span> <span class="o">=</span> <span class="s2">&#34;PHP&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$systeminfo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetSystemTotal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$systeminfo</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="s2">&#34;centos&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$basePath</span> <span class="o">=</span> <span class="s2">&#34;/www/wwwroot/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$basePath</span> <span class="o">=</span> <span class="s2">&#34;D:/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$path</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$product</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datauser</span> <span class="o">=</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datapassword</span> <span class="o">=</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$database</span> <span class="o">=</span> <span class="nx">VhostDB</span><span class="o">::</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">&#39;fIDIDProd&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;h</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;IDVHost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;ch</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;IDVHost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;product&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$database</span> <span class="o">&amp;&amp;</span> <span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;/mysql/i&#34;</span><span class="p">,</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">][</span><span class="s1">&#39;chrScript&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$datauser</span> <span class="o">=</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;DBLogin&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$datapassword</span> <span class="o">=</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;webname&#39;</span> <span class="o">=&gt;</span> <span class="nx">json_encode</span><span class="p">([</span><span class="s1">&#39;domain&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span> <span class="s1">&#39;domainlist&#39;</span> <span class="o">=&gt;</span> <span class="p">[],</span> <span class="s1">&#39;count&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">],</span> <span class="nx">JSON_UNESCAPED_UNICODE</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;check_dir&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="nv">$path</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type_id&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="nv">$type</span><span class="p">,</span> <span class="c1">//Asp Php
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s1">&#39;port&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;80&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;ftp&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;ftp_username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;ftp_password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sql&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="c1">//            &#39;sql&#39; =&gt; &#39;SQLServer&#39;,
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s1">&#39;codeing&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;utf8mb4&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;datauser&#39;</span> <span class="o">=&gt;</span> <span class="nv">$datauser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;datapassword&#39;</span> <span class="o">=&gt;</span> <span class="nv">$datapassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="nv">$version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;ps&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=AddSite&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span> <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置过期时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;siteId&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;edate&#39;</span> <span class="o">=&gt;</span> <span class="nx">date</span><span class="p">(</span><span class="s2">&#34;Y-m-d&#34;</span><span class="p">,</span> <span class="nx">strtotime</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;dtExpired&#39;</span><span class="p">])),</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s2">&#34;/site?action=SetEdate&#34;</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//设置数据库可全部人访问
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dataAccess&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;access&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s2">&#34;/database?action=SetDatabaseAccess&#34;</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">ChangePHPVersion</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$version</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 开机
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">StartInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SiteStart&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 关机
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">StopInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SiteStop&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetData</span><span class="p">(</span><span class="nv">$table</span><span class="p">,</span> <span class="nv">$search</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span><span class="p">,</span> <span class="nv">$p</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="nv">$limit</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="nv">$type</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/data?action=getData&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;table&#39;</span> <span class="o">=&gt;</span> <span class="nv">$table</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;search&#39;</span> <span class="o">=&gt;</span> <span class="nv">$search</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="nv">$p</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;limit&#39;</span> <span class="o">=&gt;</span> <span class="nv">$limit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$type</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$p</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$type</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="nx">is_array</span><span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">])</span> <span class="o">?</span> <span class="nv">$resp</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 修改数据库密码
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $password
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ModifyDatabasePasswd</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$password</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data_resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s2">&#34;databases&#34;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/database?action=ResDatabasePassword&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$data_resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">upgradeInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$systeminfo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetSystemTotal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$product</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;fIDProd&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$newProduct</span> <span class="o">=</span> <span class="nx">Product</span><span class="o">::</span><span class="na">find</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="s1">&#39;new_product_id&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$systeminfo</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="s2">&#34;centos&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$basePath</span> <span class="o">=</span> <span class="s2">&#34;/www/wwwroot/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$basePath</span> <span class="o">=</span> <span class="s2">&#34;D:/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1">//检查文件夹是否存在
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=CheckExistsFiles&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dfile&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$newProduct</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;filename&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$resp</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//目标不存在进行复制项目文件夹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=CopyFile&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;sfile&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$product</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;dfile&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$newProduct</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">!==</span> <span class="k">true</span><span class="p">)</span> <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SetPath&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nx">strval</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$newProduct</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nx">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$ftpArray</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s2">&#34;ftps&#34;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$ftpArray</span><span class="p">)</span><span class="o">||</span><span class="nv">$ftpArray</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span><span class="o">!=</span><span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$newProduct</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">){</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//删除原来的ftp账号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$ftp_remote_id</span> <span class="o">=</span> <span class="nv">$ftpArray</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/ftp?action=DeleteUser&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nx">strval</span><span class="p">(</span><span class="nv">$ftp_remote_id</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="nx">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1">//切换ftp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/ftp?action=AddUser&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;ftp_username&#39;</span> <span class="o">=&gt;</span> <span class="nx">strval</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;ftp_password&#39;</span> <span class="o">=&gt;</span> <span class="nx">strval</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}{</span><span class="nv">$newProduct</span><span class="p">[</span><span class="s1">&#39;Space&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;ps&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">||</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;与原路径一致，无需修改!&#39;</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 续费实例
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $Period
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $PeriodUnit
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">RenewInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$Period</span><span class="p">,</span> <span class="nv">$PeriodUnit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SetEdate&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// 设置过期时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;edate&#39;</span> <span class="o">=&gt;</span> <span class="nx">date</span><span class="p">(</span><span class="s2">&#34;Y-m-d&#34;</span><span class="p">,</span> <span class="nx">strtotime</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;dtExpired&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> + </span><span class="si">{</span><span class="nv">$Period</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nv">$PeriodUnit</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">StartInstance</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetSystemTotal</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/system?action=GetSystemTotal&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetSystemConfig</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/config?action=get_config&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribePHPVersion</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetPHPVersion&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$resp</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetPHPVersion</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetSitePHPVersion&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span><span class="s1">&#39;Version&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;phpversion&#39;</span><span class="p">]];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ChangePHPVersion</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$version</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SetPHPVersion&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;version&#39;</span> <span class="o">=&gt;</span> <span class="nv">$version</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 域名解绑
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $vhost
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @param $domain
</span></span></span><span class="line"><span class="cl"><span class="sd">     * @return mixed
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">RemoveBindDomain</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$domain</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=DelDomain&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;domain&#39;</span> <span class="o">=&gt;</span> <span class="nv">$domain</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;webname&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;port&#39;</span> <span class="o">=&gt;</span> <span class="mi">80</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetIndex</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetIndex&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nx">explode</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">SetIndex</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$indexArray</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SetIndex&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Index&#39;</span> <span class="o">=&gt;</span> <span class="nx">implode</span><span class="p">(</span><span class="s2">&#34;,&#34;</span><span class="p">,</span> <span class="nv">$indexArray</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">CreateBackup</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$DescribeBackup</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">DescribeBackup</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">count</span><span class="p">(</span><span class="nv">$DescribeBackup</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;count.limit&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=ToBackup&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribeBackup</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$GetSystemConfig</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetSystemConfig</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=GetDirList&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;showRow&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$GetSystemConfig</span><span class="p">[</span><span class="s1">&#39;backup_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/site&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;search&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;LIST&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;down_id&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=create_download_url&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;filename&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$GetSystemConfig</span><span class="p">[</span><span class="s1">&#39;backup_path&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/site/</span><span class="si">{</span><span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;ps&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;expire&#39;</span> <span class="o">=&gt;</span> <span class="mi">1130800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$create_download</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$down_id</span> <span class="o">=</span> <span class="nv">$create_download</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$down_id</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;down_id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$get_download_url_find</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s2">&#34;/files?action=get_download_url_find&#34;</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$down_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;filename&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;created_at&#39;</span> <span class="o">=&gt;</span> <span class="nx">date</span><span class="p">(</span><span class="s2">&#34;Y-m-d H:i:s&#34;</span><span class="p">,</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;mtime&#39;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;size&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;url&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;http://</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">:8888/down/</span><span class="si">{</span><span class="nv">$get_download_url_find</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">RemoveBackup</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$backup_remote_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$DataArray</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s1">&#39;backup&#39;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;remoteID&#39;</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$DataArray</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$filename</span> <span class="o">==</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$backup_remote_id</span> <span class="o">=</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$backup_remote_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=DelBackup&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$backup_remote_id</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribeAccessLog</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetSiteLogs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=GetDirList&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;showRow&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;is_operating&#39;</span> <span class="o">=&gt;</span> <span class="k">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileResp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$fileResp</span><span class="p">[</span><span class="s1">&#39;LIST&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DownloadAccessLog</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//获取文件夹位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetSiteLogs&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$fileArray</span> <span class="o">=</span> <span class="nx">explode</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sfile</span> <span class="o">=</span> <span class="nx">array_pop</span><span class="p">(</span><span class="nv">$fileArray</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$basePath</span> <span class="o">=</span> <span class="nx">implode</span><span class="p">(</span><span class="s2">&#34;/&#34;</span><span class="p">,</span> <span class="nv">$fileArray</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//        //删除文件
</span></span></span><span class="line"><span class="cl"><span class="c1">//        $action = &#34;/files?action=DeleteFile&#34;;
</span></span></span><span class="line"><span class="cl"><span class="c1">//        $p = [
</span></span></span><span class="line"><span class="cl"><span class="c1">//            &#39;path&#39; =&gt; &#34;{$basePath}/{$sfile}.zip&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1">//        ];
</span></span></span><span class="line"><span class="cl"><span class="c1">//        $this-&gt;request($action, $p);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="c1">//压缩文件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=Zip&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sfile&#39;</span> <span class="o">=&gt;</span> <span class="nv">$sfile</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dfile&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$sfile</span><span class="si">}</span><span class="s2">.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;z_type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}</span><span class="s2">/&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">])</span> <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=GetDirList&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;p&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;showRow&#39;</span> <span class="o">=&gt;</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="nv">$basePath</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;search&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$sfile</span><span class="si">}</span><span class="s2">.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s2">&#34;LIST&#34;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nx">count</span><span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s2">&#34;LIST&#34;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s2">&#34;LIST&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;down_id&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$get_download_url_find</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="s2">&#34;/files?action=get_download_url_find&#34;</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s2">&#34;LIST&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;down_id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$get_download_url_find</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//生成外链
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=create_download_url&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;filename&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$sfile</span><span class="si">}</span><span class="s2">.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;ps&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$sfile</span><span class="si">}</span><span class="s2">.zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;expire&#39;</span> <span class="o">=&gt;</span> <span class="mi">1130800</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$create_download_url</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$token</span> <span class="o">=</span> <span class="nv">$create_download_url</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">][</span><span class="s1">&#39;token&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;url&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Content&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;http://</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">port</span><span class="si">}</span><span class="s2">/down/</span><span class="si">{</span><span class="nv">$token</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribeNetVersion</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=get_iis_net_versions&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ModifyNetVersion</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$version</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=set_iis_apppool&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;model&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;Integrated&#39;</span><span class="p">,</span>  <span class="c1">// Integrated  集成    Classic 经典
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="s1">&#39;net_version&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$version</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;enable32BitAppOnWin64&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;true&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;queueLength&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;10000&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">isset</span><span class="p">(</span><span class="nv">$param</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$p</span><span class="p">[</span><span class="s1">&#39;model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$param</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetNetConfig</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=get_net_version_byaspp&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ChangeApppoolStatus</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$status</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=set_apppool_status&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="nv">$status</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID</span><span class="p">,</span> <span class="nv">$resp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetRewriteList</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetRewriteList&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s2">&#34;rewrite&#34;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$item</span> <span class="o">==</span> <span class="s1">&#39;0.当前&#39;</span> <span class="o">?</span> <span class="s1">&#39;self&#39;</span> <span class="o">:</span> <span class="nv">$item</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetFileBody</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$template</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$systeminfo</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetSystemTotal</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$systeminfo</span><span class="p">[</span><span class="s1">&#39;system&#39;</span><span class="p">],</span> <span class="s2">&#34;centos&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$basePath</span> <span class="o">=</span> <span class="s2">&#34;/www/wwwroot/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$basePath</span> <span class="o">=</span> <span class="s2">&#34;D:/&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=GetFileBody&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$basePath</span><span class="si">}</span><span class="s2">/BtSoft/panel/rewrite/iis/</span><span class="si">{</span><span class="nv">$template</span><span class="si">}</span><span class="s2">.conf&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetSiteRewrite</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=GetSiteRewrite&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;content&#39;</span> <span class="o">=&gt;</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">SetSiteRewrite</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=SetSiteRewrite&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;siteName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;data&#39;</span> <span class="o">=&gt;</span> <span class="nv">$content</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribeSiteErrorPages</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=get_site_error_pages&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$data</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;list&#39;</span><span class="p">]</span> <span class="k">as</span> <span class="nv">$item</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;code&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;statusCode&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s1">&#39;mode&#39;</span> <span class="o">=&gt;</span> <span class="nv">$item</span><span class="p">[</span><span class="s1">&#39;responseMode&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;File&#39;</span> <span class="o">?</span> <span class="s1">&#39;default&#39;</span> <span class="o">:</span> <span class="s1">&#39;self&#39;</span>
</span></span><span class="line"><span class="cl">            <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$data</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">SetErrorPage</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$code</span><span class="p">,</span> <span class="nv">$path</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">stripos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span> <span class="s2">&#34;%SystemDrive%&#34;</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="s2">&#34;path.error&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=set_error_page_bycode&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;code&#39;</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;responseMode&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;ExecuteURL&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;/</span><span class="si">{</span><span class="nv">$path</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">ResetErrorPage</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$code</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/site?action=re_error_page_bycode&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;code&#39;</span> <span class="o">=&gt;</span> <span class="nv">$code</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">UnZip</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$filename</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=UnZip&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sfile&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;D:/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Quota&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$filename</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dfile&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;D:/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Quota&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;zip&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;coding&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;UTF-8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">GetNetWork</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/system?action=GetNetWork&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">StartFtp</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$GetData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s1">&#39;ftps&#39;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/ftp?action=SetStatus&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$GetData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">StopFtp</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$GetData</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">GetData</span><span class="p">(</span><span class="s1">&#39;ftps&#39;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/ftp?action=SetStatus&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$GetData</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;status&#39;</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">private</span> <span class="k">function</span> <span class="nf">get_mssql_row</span><span class="p">(</span><span class="nv">$database</span><span class="p">,</span> <span class="nv">$query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$dbcfg</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;server&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">host</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;username&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;sa&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mssql_password</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;database&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;mssql_connect&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$link</span> <span class="o">=</span> <span class="o">@</span><span class="nx">mssql_connect</span><span class="p">(</span><span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">],</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mssql_select_db</span><span class="p">(</span><span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">],</span> <span class="nv">$link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$res</span> <span class="o">=</span> <span class="o">@</span><span class="nx">mssql_query</span><span class="p">(</span><span class="nv">$query</span><span class="p">,</span> <span class="nv">$link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$row</span> <span class="o">=</span> <span class="o">@</span><span class="nx">mssql_fetch_assoc</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">mssql_free_result</span><span class="p">(</span><span class="nv">$res</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="o">@</span><span class="nx">mssql_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;odbc_pconnect&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$conn</span> <span class="o">=</span> <span class="nx">odbc_pconnect</span><span class="p">(</span><span class="s2">&#34;Driver={ODBC Driver 17 for SQL Server};Server=</span><span class="si">{</span><span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">;DataBase=</span><span class="si">{</span><span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$result</span> <span class="o">=</span> <span class="nx">odbc_exec</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$row</span> <span class="o">=</span> <span class="nx">odbc_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">odbc_close</span><span class="p">(</span><span class="nv">$conn</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nx">function_exists</span><span class="p">(</span><span class="s1">&#39;sqlsrv_connect&#39;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$connectionInfo</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="s2">&#34;Database&#34;</span> <span class="o">=&gt;</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">],</span> <span class="s2">&#34;UID&#34;</span> <span class="o">=&gt;</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="s2">&#34;PWD&#34;</span> <span class="o">=&gt;</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$link</span> <span class="o">=</span> <span class="nx">sqlsrv_connect</span><span class="p">(</span><span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">],</span> <span class="nv">$connectionInfo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$result</span> <span class="o">=</span> <span class="nx">sqlsrv_query</span><span class="p">(</span><span class="nv">$link</span><span class="p">,</span> <span class="nv">$query</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$row</span> <span class="o">=</span> <span class="nx">sqlsrv_fetch_array</span><span class="p">(</span><span class="nv">$result</span><span class="p">,</span> <span class="nx">SQLSRV_FETCH_ASSOC</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="nx">sqlsrv_close</span><span class="p">(</span><span class="nv">$link</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$host</span> <span class="o">=</span> <span class="s2">&#34;sqlsrv:Server=&#34;</span> <span class="o">.</span> <span class="nx">str_replace</span><span class="p">(</span><span class="s2">&#34;:&#34;</span><span class="p">,</span> <span class="s2">&#34;,&#34;</span><span class="p">,</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">])</span> <span class="o">.</span> <span class="s2">&#34;;Database=&#34;</span> <span class="o">.</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span> <span class="o">.</span> <span class="s2">&#34;;&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">PDO</span><span class="p">(</span><span class="nv">$host</span><span class="p">,</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span> <span class="nv">$dbcfg</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$row</span> <span class="o">=</span> <span class="p">[];</span>
</span></span><span class="line"><span class="cl">            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$obj</span><span class="o">-&gt;</span><span class="na">query</span><span class="p">(</span><span class="nv">$query</span><span class="p">)</span> <span class="k">as</span> <span class="nv">$val</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$row</span> <span class="o">=</span> <span class="nv">$val</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$row</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="sd">/**
</span></span></span><span class="line"><span class="cl"><span class="sd">     * 创建数据库
</span></span></span><span class="line"><span class="cl"><span class="sd">     */</span>
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">AddDatabase</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$siteId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$datauser</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$datapassword</span> <span class="o">=</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$database</span> <span class="o">=</span> <span class="nx">VhostDB</span><span class="o">::</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">&#39;fIDIDProd&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;h</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;IDVHost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;ch</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;IDVHost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;product&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">first</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$database</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;/mysql/i&#34;</span><span class="p">,</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">][</span><span class="s1">&#39;chrScript&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$datauser</span> <span class="o">=</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;DBLogin&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$datapassword</span> <span class="o">=</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">]</span> <span class="o">?</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">]</span> <span class="o">:</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Password&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//数据库不能字母开头,如果迁移后的ftp是数字开通的,更换一下数据库名
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="nx">intval</span><span class="p">(</span><span class="nv">$datauser</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nv">$datauser</span> <span class="o">=</span> <span class="s2">&#34;h</span><span class="si">{</span><span class="nv">$datauser</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/database?action=AddDatabase&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="nv">$datauser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;codeing&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;utf8&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;db_user&#39;</span> <span class="o">=&gt;</span> <span class="nv">$datauser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;password&#39;</span> <span class="o">=&gt;</span> <span class="nv">$datapassword</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dtype&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;SQLServer&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;contact&#39;</span> <span class="o">=&gt;</span> <span class="nv">$siteId</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;dataAccess&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;address&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;ps&#39;</span> <span class="o">=&gt;</span> <span class="nv">$datauser</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID_AddDatabase</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$AddDatabaseResp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID_AddDatabase</span><span class="p">,</span> <span class="nv">$AddDatabaseResp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="nv">$AddDatabaseResp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">try</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">get_mssql_row</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms&#34;</span><span class="p">,</span> <span class="s2">&#34;ALTER DATABASE [</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms] MODIFY FILE ( NAME = N&#39;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms&#39;, MAXSIZE = 100MB )&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Throwable</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nx">WebLog</span><span class="o">::</span><span class="na">log</span><span class="p">(</span><span class="s2">&#34;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> 修改mssql容量失败:&#34;</span> <span class="o">.</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$AddDatabaseResp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$AddDatabaseResp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">BatchRemoveCrontab</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/crontab?action=GetCrontab&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;page&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$CrontabList</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$CrontabList</span> <span class="k">as</span> <span class="nv">$crontab</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nv">$crontab</span><span class="p">[</span><span class="s1">&#39;sType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;database&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">in_array</span><span class="p">(</span><span class="nv">$crontab</span><span class="p">[</span><span class="s1">&#39;sName&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&#34;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms&#34;</span><span class="p">,</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">RemoveCrontab</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$crontab</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">elseif</span> <span class="p">(</span><span class="nv">$crontab</span><span class="p">[</span><span class="s1">&#39;sType&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;site&#39;</span> <span class="o">&amp;&amp;</span> <span class="nv">$crontab</span><span class="p">[</span><span class="s1">&#39;sName&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">])</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">RemoveCrontab</span><span class="p">([</span><span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$crontab</span><span class="p">]);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">RemoveCrontab</span><span class="p">(</span><span class="nv">$crontab</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/crontab?action=DelCrontab&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;id&#39;</span> <span class="o">=&gt;</span> <span class="nv">$crontab</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$resp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">===</span> <span class="k">true</span> <span class="o">?</span> <span class="k">true</span> <span class="o">:</span> <span class="nv">$resp</span><span class="p">[</span><span class="s1">&#39;msg&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">BatchAddCrontab</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//创建计划任务定时备份
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/crontab?action=AddCrontab&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sType&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;site&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;备份网站[</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;hour&#39;</span> <span class="o">=&gt;</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;backupTo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;save&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sBody&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$logID_AddCrontab</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logRequest</span><span class="p">(</span><span class="nx">array_merge</span><span class="p">(</span><span class="nv">$p</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;action&#39;</span> <span class="o">=&gt;</span> <span class="nv">$action</span><span class="p">]));</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$AddCrontabResp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logResponse</span><span class="p">(</span><span class="nv">$logID_AddCrontab</span><span class="p">,</span> <span class="nv">$AddCrontabResp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$databaseList</span> <span class="o">=</span> <span class="nx">VhostDB</span><span class="o">::</span><span class="na">whereIn</span><span class="p">(</span><span class="s1">&#39;fIDIDProd&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&#34;h</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;IDVHost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span> <span class="s2">&#34;ch</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;IDVHost&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">with</span><span class="p">([</span><span class="s1">&#39;product&#39;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="o">-&gt;</span><span class="na">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$mysql_sName</span> <span class="o">=</span> <span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$mssql_sName</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$databaseList</span> <span class="k">as</span> <span class="nv">$database</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="p">(</span><span class="nx">preg_match</span><span class="p">(</span><span class="s2">&#34;/mysql/i&#34;</span><span class="p">,</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;product&#39;</span><span class="p">][</span><span class="s1">&#39;chrScript&#39;</span><span class="p">]))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$mysql_sName</span> <span class="o">=</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;DBLogin&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nv">$mssql_sName</span> <span class="o">=</span> <span class="nv">$database</span><span class="p">[</span><span class="s1">&#39;DBLogin&#39;</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sType&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;备份数据库[</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;hour&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$mysql_sName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;backupTo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;save&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sBody&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sType&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;database&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;name&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;备份数据库[</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;UserName&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">_ms]&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;hour&#39;</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;minute&#39;</span> <span class="o">=&gt;</span> <span class="mi">30</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sName&#39;</span> <span class="o">=&gt;</span> <span class="nv">$mssql_sName</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;backupTo&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;localhost&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;save&#39;</span> <span class="o">=&gt;</span> <span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;sBody&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">public</span> <span class="k">function</span> <span class="nf">DescribeInstanceMonitorData</span><span class="p">(</span><span class="nv">$vhost</span><span class="p">,</span> <span class="nv">$param</span> <span class="o">=</span> <span class="p">[])</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$action</span> <span class="o">=</span> <span class="s2">&#34;/files?action=get_path_size&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$p</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;path&#39;</span> <span class="o">=&gt;</span> <span class="s2">&#34;D:/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;Quota&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nv">$vhost</span><span class="p">[</span><span class="s1">&#39;chrDomain&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">        <span class="nv">$sizeResp</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">request</span><span class="p">(</span><span class="nv">$action</span><span class="p">,</span> <span class="nv">$p</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="s1">&#39;Size&#39;</span> <span class="o">=&gt;</span> <span class="nv">$sizeResp</span><span class="p">[</span><span class="s1">&#39;size&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h4 id="window-版">window 版<a hidden class="anchor" aria-hidden="true" href="#window-版">#</a></h4>
<ol>
<li>安装宝塔至d盘</li>
<li>打开服务器管理器-&gt;添加角色和功能-&gt;服务器角色-&gt;文件和存储服务-&gt;文件和ISCSI服务-&gt;文件服务器资源管理器
<img loading="lazy" src="/images/vhost/001.png" alt="步骤1"  title="image"  />

<img loading="lazy" src="/images/vhost/002.png" alt="步骤2"  title="image"  />
</li>
<li>打开文件服務器資源管理器<br>
<img loading="lazy" src="/images/vhost/003.png" alt="步骤3"  title="image"  />

<img loading="lazy" src="/images/vhost/004.png" alt="步骤4"  title="image"  />

<img loading="lazy" src="/images/vhost/005.png" alt="步骤5"  title="image"  />

<img loading="lazy" src="/images/vhost/006.png" alt="步骤6"  title="image"  />
</li>
</ol>


    </div>

    <footer class="post-footer">
        <ul class="post-tags">
            <li><a href="/tags/baota/">baota</a></li>
        </ul>
<nav class="paginav">
  <a class="prev" href="/tech/php-imap/">
    <span class="title">« 上一页</span>
    <br>
    <span>Php邮件收取imap</span>
  </a>
  <a class="next" href="/tech/php-punycode/">
    <span class="title">下一页 »</span>
    <br>
    <span>Php-编码解码punycode</span>
  </a>
</nav>

    </footer>
</article>
<script src="https://giscus.app/client.js"
        data-repo="suguer/giscus.github.io"
        data-repo-id="R_kgDOH08FpA"
        data-category="Announcements"
        data-category-id="DIC_kwDOH08FpM4CQ2jj"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="/">Ken Blog</a></span>
    <span>
       Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19150058号</a>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
