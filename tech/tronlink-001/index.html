<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>tronlink-从0到1搭建自己的归集系统 | Ken Blog</title>
<meta name="keywords" content="tronlink">
<meta name="description" content="前言 对于某些网站平台如果想支持收取波场区块链,但是又不清楚完整的流程应该如何部署的话,这里可以提供一套较为完整的方案,实现如商城下支持对客户的在线支付,
目标 实现客户在线支付,收取波场链的usdt或usdc,并且自动支付和激活订单,最后能归集到一个账户上自由使用
前置条件 在波场链有足够的trx,数量的多少取决于你对于归集的效率的需求,如果需要归集的周期越短,效率越快,则需要的trx越多
1个总钱包,其中会扩展的功能有,分发冻结能量,收款,激活钱包,也可以看业务需要拆开成3个钱包
开发环境: python mysql
正式内容 所有的接口以及交互均来自 波场链官网文档 ,如果对于文档不太熟的同学请先阅读了解下波场链的交易流程
主要数据结构 节点数据 block_chain_block
数据类型 类型 描述 id bigint 区块节点 total int 总交易数 active int 已激活交易数 created_at timestamp 创建时间 updated_at timestamp 更新时间 started_at timestamp 开始执行时间 ended_at timestamp 结束执行时间 block_at timestamp 节点时间 error timestamp 节点错误信息 钱包数据 block_chain_wallet
数据类型 类型 描述 id int 自增id address varchar(255) 地址 private_key varchar(1024) 地址密钥(建议保存到数据库时加密) user_id int 客户用户ID created_at timestamp 创建时间 updated_at timestamp 更新时间 deposit decimal(30,6) 余额 status varchar(16) 状态 扫块系统 想要获取到链上所有的交易信息,主要有两种方式,第一自建超级节点服务器,这样就可以频繁获取数据而不受限制,但是对于一般的网站平台来说,搭建一台波场链节点服务器浪费了资金,因此这里采用第二种方式,通过官网提供的接口进行查询同步,需注意本文涉及用到的接口均是固块化API">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="/tech/tronlink-001/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.4398b09e795c3aac93a04f4160281925a588bcdf14941ead87ab7bfe555ba854.css" integrity="sha256-Q5iwnnlcOqyToE9BYCgZJaWIvN8UlB6th6t7/lVbqFQ=" rel="preload stylesheet" as="style">
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="mask-icon" href="/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="tronlink-从0到1搭建自己的归集系统" />
<meta property="og:description" content="前言 对于某些网站平台如果想支持收取波场区块链,但是又不清楚完整的流程应该如何部署的话,这里可以提供一套较为完整的方案,实现如商城下支持对客户的在线支付,
目标 实现客户在线支付,收取波场链的usdt或usdc,并且自动支付和激活订单,最后能归集到一个账户上自由使用
前置条件 在波场链有足够的trx,数量的多少取决于你对于归集的效率的需求,如果需要归集的周期越短,效率越快,则需要的trx越多
1个总钱包,其中会扩展的功能有,分发冻结能量,收款,激活钱包,也可以看业务需要拆开成3个钱包
开发环境: python mysql
正式内容 所有的接口以及交互均来自 波场链官网文档 ,如果对于文档不太熟的同学请先阅读了解下波场链的交易流程
主要数据结构 节点数据 block_chain_block
数据类型 类型 描述 id bigint 区块节点 total int 总交易数 active int 已激活交易数 created_at timestamp 创建时间 updated_at timestamp 更新时间 started_at timestamp 开始执行时间 ended_at timestamp 结束执行时间 block_at timestamp 节点时间 error timestamp 节点错误信息 钱包数据 block_chain_wallet
数据类型 类型 描述 id int 自增id address varchar(255) 地址 private_key varchar(1024) 地址密钥(建议保存到数据库时加密) user_id int 客户用户ID created_at timestamp 创建时间 updated_at timestamp 更新时间 deposit decimal(30,6) 余额 status varchar(16) 状态 扫块系统 想要获取到链上所有的交易信息,主要有两种方式,第一自建超级节点服务器,这样就可以频繁获取数据而不受限制,但是对于一般的网站平台来说,搭建一台波场链节点服务器浪费了资金,因此这里采用第二种方式,通过官网提供的接口进行查询同步,需注意本文涉及用到的接口均是固块化API" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/tech/tronlink-001/" /><meta property="og:image" content="/papermod-cover.png"/><meta property="article:section" content="tech" />
<meta property="article:published_time" content="2022-08-16T10:15:00&#43;08:00" />
<meta property="article:modified_time" content="2022-08-16T10:15:00&#43;08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="/papermod-cover.png"/>

<meta name="twitter:title" content="tronlink-从0到1搭建自己的归集系统"/>
<meta name="twitter:description" content="前言 对于某些网站平台如果想支持收取波场区块链,但是又不清楚完整的流程应该如何部署的话,这里可以提供一套较为完整的方案,实现如商城下支持对客户的在线支付,
目标 实现客户在线支付,收取波场链的usdt或usdc,并且自动支付和激活订单,最后能归集到一个账户上自由使用
前置条件 在波场链有足够的trx,数量的多少取决于你对于归集的效率的需求,如果需要归集的周期越短,效率越快,则需要的trx越多
1个总钱包,其中会扩展的功能有,分发冻结能量,收款,激活钱包,也可以看业务需要拆开成3个钱包
开发环境: python mysql
正式内容 所有的接口以及交互均来自 波场链官网文档 ,如果对于文档不太熟的同学请先阅读了解下波场链的交易流程
主要数据结构 节点数据 block_chain_block
数据类型 类型 描述 id bigint 区块节点 total int 总交易数 active int 已激活交易数 created_at timestamp 创建时间 updated_at timestamp 更新时间 started_at timestamp 开始执行时间 ended_at timestamp 结束执行时间 block_at timestamp 节点时间 error timestamp 节点错误信息 钱包数据 block_chain_wallet
数据类型 类型 描述 id int 自增id address varchar(255) 地址 private_key varchar(1024) 地址密钥(建议保存到数据库时加密) user_id int 客户用户ID created_at timestamp 创建时间 updated_at timestamp 更新时间 deposit decimal(30,6) 余额 status varchar(16) 状态 扫块系统 想要获取到链上所有的交易信息,主要有两种方式,第一自建超级节点服务器,这样就可以频繁获取数据而不受限制,但是对于一般的网站平台来说,搭建一台波场链节点服务器浪费了资金,因此这里采用第二种方式,通过官网提供的接口进行查询同步,需注意本文涉及用到的接口均是固块化API"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Teches",
      "item": "/tech/"
    }
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "tronlink-从0到1搭建自己的归集系统",
      "item": "/tech/tronlink-001/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "tronlink-从0到1搭建自己的归集系统",
  "name": "tronlink-从0到1搭建自己的归集系统",
  "description": "前言 对于某些网站平台如果想支持收取波场区块链,但是又不清楚完整的流程应该如何部署的话,这里可以提供一套较为完整的方案,实现如商城下支持对客户的在线支付,\n目标 实现客户在线支付,收取波场链的usdt或usdc,并且自动支付和激活订单,最后能归集到一个账户上自由使用\n前置条件 在波场链有足够的trx,数量的多少取决于你对于归集的效率的需求,如果需要归集的周期越短,效率越快,则需要的trx越多\n1个总钱包,其中会扩展的功能有,分发冻结能量,收款,激活钱包,也可以看业务需要拆开成3个钱包\n开发环境: python mysql\n正式内容 所有的接口以及交互均来自 波场链官网文档 ,如果对于文档不太熟的同学请先阅读了解下波场链的交易流程\n主要数据结构 节点数据 block_chain_block\n数据类型 类型 描述 id bigint 区块节点 total int 总交易数 active int 已激活交易数 created_at timestamp 创建时间 updated_at timestamp 更新时间 started_at timestamp 开始执行时间 ended_at timestamp 结束执行时间 block_at timestamp 节点时间 error timestamp 节点错误信息 钱包数据 block_chain_wallet\n数据类型 类型 描述 id int 自增id address varchar(255) 地址 private_key varchar(1024) 地址密钥(建议保存到数据库时加密) user_id int 客户用户ID created_at timestamp 创建时间 updated_at timestamp 更新时间 deposit decimal(30,6) 余额 status varchar(16) 状态 扫块系统 想要获取到链上所有的交易信息,主要有两种方式,第一自建超级节点服务器,这样就可以频繁获取数据而不受限制,但是对于一般的网站平台来说,搭建一台波场链节点服务器浪费了资金,因此这里采用第二种方式,通过官网提供的接口进行查询同步,需注意本文涉及用到的接口均是固块化API",
  "keywords": [
    "tronlink"
  ],
  "articleBody": "前言 对于某些网站平台如果想支持收取波场区块链,但是又不清楚完整的流程应该如何部署的话,这里可以提供一套较为完整的方案,实现如商城下支持对客户的在线支付,\n目标 实现客户在线支付,收取波场链的usdt或usdc,并且自动支付和激活订单,最后能归集到一个账户上自由使用\n前置条件 在波场链有足够的trx,数量的多少取决于你对于归集的效率的需求,如果需要归集的周期越短,效率越快,则需要的trx越多\n1个总钱包,其中会扩展的功能有,分发冻结能量,收款,激活钱包,也可以看业务需要拆开成3个钱包\n开发环境: python mysql\n正式内容 所有的接口以及交互均来自 波场链官网文档 ,如果对于文档不太熟的同学请先阅读了解下波场链的交易流程\n主要数据结构 节点数据 block_chain_block\n数据类型 类型 描述 id bigint 区块节点 total int 总交易数 active int 已激活交易数 created_at timestamp 创建时间 updated_at timestamp 更新时间 started_at timestamp 开始执行时间 ended_at timestamp 结束执行时间 block_at timestamp 节点时间 error timestamp 节点错误信息 钱包数据 block_chain_wallet\n数据类型 类型 描述 id int 自增id address varchar(255) 地址 private_key varchar(1024) 地址密钥(建议保存到数据库时加密) user_id int 客户用户ID created_at timestamp 创建时间 updated_at timestamp 更新时间 deposit decimal(30,6) 余额 status varchar(16) 状态 扫块系统 想要获取到链上所有的交易信息,主要有两种方式,第一自建超级节点服务器,这样就可以频繁获取数据而不受限制,但是对于一般的网站平台来说,搭建一台波场链节点服务器浪费了资金,因此这里采用第二种方式,通过官网提供的接口进行查询同步,需注意本文涉及用到的接口均是固块化API\n查询当前最新节点 文档 通过接口获取到当前最新节点和本地已同步的节点比较,能知道当前程序同步的情况如何,如果存在\"追不上\"差值越来越大,可能需要增加线程处理等方式 接口: /walletsolidity/getnowblock\n{ \"blockID\": \"000000000198e6cee71c8e83366b925e64c5cf715529ac009bfbaff132e98d6b\", \"block_header\": { \"raw_data\": { \"number\": 26797774, \"txTrieRoot\": \"f5689c087055959a66ac7638e79c57319dffb84631992852791a3f47784b267e\", \"witness_address\": \"41d42e593de3cee8156934cc2182ef4d107e9291f0\", \"parentHash\": \"000000000198e6cde394799dcc330b00422a8cc028be767526e1f1500afcd682\", \"version\": 24, \"timestamp\": 1660618479000 }, \"witness_signature\": \"c4317733f65fe7a9f3d235f9037b903cb1e3c6b2192f4dce5a24930c92f0663167ed9dbbdb5c134692c107416d44a874d07fd62dc61fed4bde318eae3adf8f0300\" }, \"transactions\": [ { \"ret\": [ { \"contractRet\": \"SUCCESS\" } ], \"signature\": [ \"fd0750453b2ae27ae02df417b724518ceac4fb432181f30dafddc2e73d83784768143ae9e12cb15816c9f852436f48303fd927aa3e6908cc9880ecf505fffe8300\" ], \"txID\": \"92e168626aa79ed3c307ce2030acf12aa92dcb6114f66b53a8243dba738ea720\", \"raw_data\": { \"contract\": [ { \"parameter\": { \"value\": { \"amount\": 650, \"owner_address\": \"411b51ed3f22cec14b4c53abb99c4f5bff1aa5b5d1\", \"to_address\": \"41a7040c812f5e8188243bc781dfbcace984ec832b\" }, \"type_url\": \"type.googleapis.com/protocol.TransferContract\" }, \"type\": \"TransferContract\" } ], \"ref_block_bytes\": \"e6bb\", \"ref_block_hash\": \"2f39e8e056fb3672\", \"expiration\": 1660618536000, \"timestamp\": 1660618476362 }, \"raw_data_hex\": \"0a02e6bb22082f39e8e056fb367240c0e8cfa4aa305a66080112620a2d747970652e676f6f676c65617069732e636f6d2f70726f746f636f6c2e5472616e73666572436f6e747261637412310a15411b51ed3f22cec14b4c53abb99c4f5bff1aa5b5d1121541a7040c812f5e8188243bc781dfbcace984ec832b188a0570ca96cca4aa30\" }, { \"ret\": [ { \"contractRet\": \"SUCCESS\" } ], \"signature\": [ \"6fc213cc693d9aadf7941792e5ee35dd33203290428391be499e9ea1f9799febbc5265eea5ed342b5c006a8a9e7113bbc34ecf148005e32cd8ea127ecbd094a700\" ], \"txID\": \"48855473d1263692f6b8ce34c654996cdb05d89fcbd7c8eb152736fcd4c10bb7\", \"raw_data\": { \"contract\": [ { \"parameter\": { \"value\": { \"amount\": 60500, \"owner_address\": \"41b3dbb883203c53cdf3d7d85521ee8322c1d92125\", \"to_address\": \"41000e42c42d4d525eb291ef7374da28d3f251c9b0\" }, \"type_url\": \"type.googleapis.com/protocol.TransferContract\" }, \"type\": \"TransferContract\" } ], \"ref_block_bytes\": \"e6bb\", \"ref_block_hash\": \"2f39e8e056fb3672\", \"expiration\": 1660618537006, \"timestamp\": 1660618477006 }, \"raw_data_hex\": \"0a02e6bb22082f39e8e056fb367240aef0cfa4aa305a67080112630a2d747970652e676f6f676c65617069732e636f6d2f70726f746f636f6c2e5472616e73666572436f6e747261637412320a1541b3dbb883203c53cdf3d7d85521ee8322c1d92125121541000e42c42d4d525eb291ef7374da28d3f251c9b018d4d80370ce9bcca4aa30\" } ] } 当前节点为 now_block_num = int(GetNowBlock.get(‘block_header’).get(‘raw_data’).get(’number’))\n查询数据表中已同步最新的节点 block = session.query(BlockChainBlock).order_by(BlockChainBlock.id.desc()).first() if block is None: blocksnum = now_block_num - 95 else: blocksnum = block.id + 1 if blocksnum \u003e now_block_num: print(\"扫块速度过快超过波场出块,停歇一会\") time.sleep(3) continue 每次按批查询一定节点的数据 min_block_num = min(blocksnum + 30, now_block_num) for i in range(blocksnum, min_block_num): block = session.query(BlockChainBlock).filter(BlockChainBlock.id == i).first() if block is not None: continue else: block = BlockChainBlock( id=i, total=0, active=0, created_at=datetime.datetime.now(), updated_at=datetime.datetime.now(), ) session.add(block) session.commit() req = WorkRequest(handleThread, args=[i, 1], kwds={}) main.putRequest(req) # 将之前没同步到的区块重新查一下 history_block_list = session.query(BlockChainBlock) \\ .filter( # BlockChainBlock.ended_at == None, BlockChainBlock.error == '503 Service Temporarily Unavailable', BlockChainBlock.updated_at \u003c= (datetime.datetime.now() - datetime.timedelta(minutes=15)).strftime(\"%Y-%m-%d %H:%M:%S\")) \\ .all() for block in history_block_list: block.updated_at = datetime.datetime.now() session.add(block) session.commit() req = WorkRequest(handleThread, args=[block.id, 1], kwds={}) main.putRequest(req) try: # 清理一下历史没问题的节点数据,释放数据库空间 session.query(BlockChainBlock).filter( BlockChainBlock.active == 0, # BlockChainBlock.ended_at != None, BlockChainBlock.updated_at \u003c= (datetime.datetime.now() - datetime.timedelta(hours=6)).strftime(\"%Y-%m-%d %H:%M:%S\") ).delete() session.commit() except Exception as e: print(e) pass # 如果当前最新需同步的区块较少的,可等待久点累积一下 if min_block_num - blocksnum \u003c 5: time.sleep(10) else: time.sleep(1) 处理节点数据,获取交易列表详情\n这段的代码比较多,基本来说就是获取每个节点下的交易数据,然后把每条交易数据进行解析,获取需要合约地址,金额,对象,时间,这样处理后扫块的流程基本就完结 pool_engine = create_engine(config.SQLALCHEMY_DATABASE_URI, pool_size=10, max_overflow=10, pool_timeout=180) PoolSession = sessionmaker(bind=pool_engine) def handleThread(blocksnum, delay=0): trx = Trx(None) session = PoolSession() block = session.query(BlockChainBlock).filter(BlockChainBlock.id == blocksnum).first() #更新开始执行时间 block.started_at = datetime.datetime.now() block.error = \"\" session.add(block) session.commit() try: #获取当前节点的全部交易数据 transactionsData = trx.get_walletsolidity_block_by_num(block.id) except Exception as e: print(\"get_walletsolidity_block_by_num\") print(e) block.error = \"503 Service Temporarily Unavailable\" block.ended_at = datetime.datetime.now() session.add(block) session.commit() session.close() return try: transaction_at = (transactionsData['block_header']['raw_data']['timestamp']) / 1000 transaction_at = time.strftime(\"%Y-%m-%d %H:%M:%S\", time.localtime(transaction_at)) except Exception as e: print(e) block.error = \"not timestamp\" block.ended_at = datetime.datetime.now() session.add(block) session.commit() session.close() return if transactionsData.get(\"transactions\") is None: block.error = \"not transactions\" block.ended_at = datetime.datetime.now() block.block_at = transaction_at session.add(block) session.commit() session.close() return block.block_at = transaction_at block.total = len(transactionsData['transactions']) session.add(block) session.commit() active = 0 exist_count = 0 for transaction in transactionsData['transactions']: out_trade_no = transaction['txID'] status = transaction['ret'][0]['contractRet'].lower() if status != 'success': continue try: contract = transaction['raw_data']['contract'][0]['parameter']['value']['contract_address'] contract = keys.to_base58check_address(contract) except: continue #active_contract = None #for contract_address in config_contract.contract_address: # if contract_address.get(\"address\") == contract: # active_contract = contract_address # break #if active_contract is None: # continue func = transaction['raw_data'][\"contract\"][0][\"parameter\"][\"value\"][\"data\"][0:8] if func != \"a9059cbb\": continue to_address = keys.to_base58check_address( transaction['raw_data'][\"contract\"][0][\"parameter\"][\"value\"][\"data\"][9:72].lstrip(\"0\")) try: transactionAmount = int( transaction['raw_data'][\"contract\"][0][\"parameter\"][\"value\"][\"data\"][72:].lstrip(\"0\"), 16) / 1000000 except: continue # transaction_at 交易时间 # contract 合约地址 # to_address 收款地址 # transactionAmount 收款金额 # 实现自己的功能 block.ended_at = datetime.datetime.now() block.doed_at = transaction_at block.active = active session.add(block) session.commit() 多线程处理 handleThread 节点之间的数据查询并不会影响,因此在处理节点数据handleThread的时候,可增加多线程来操作,加快扫块的效率 本文主要讲述的是扫块的模块,还有冻结能量的模块另外再展开说明\n",
  "wordCount" : "573",
  "inLanguage": "zh",
  "datePublished": "2022-08-16T10:15:00+08:00",
  "dateModified": "2022-08-16T10:15:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "/tech/tronlink-001/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Ken Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "/favicon.ico"
    }
  }
}
</script><meta name="shenma-site-verification" content="fa86e3feb16384882d9270489eab2715_1660870831">
<meta name="360-site-verification" content="fd75df938cdcbc7973283e01cd15fecb" />

</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="/" accesskey="h" title="Ken Blog (Alt + H)">Ken Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
    <header class="post-header">
        <div class="breadcrumbs"><a href="/">主页</a>&nbsp;»&nbsp;<a href="/tech/">Teches</a></div>
        <h1 class="post-title">
            tronlink-从0到1搭建自己的归集系统
        </h1>
        <div class="post-meta"><span title='2022-08-16 10:15:00 +0800 CST'>八月 16, 2022</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;Theme PaperMod&nbsp;|&nbsp;<a href="https://github.com/adityatelange/hugo-PaperMod/tree/exampleSite/content/tech/tronlink-001.md" rel="noopener noreferrer" target="_blank">Suggest Changes</a>

</div>
    </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%89%8d%e8%a8%80" aria-label="前言">前言</a></li>
                <li>
                    <a href="#%e7%9b%ae%e6%a0%87" aria-label="目标">目标</a></li>
                <li>
                    <a href="#%e5%89%8d%e7%bd%ae%e6%9d%a1%e4%bb%b6" aria-label="前置条件">前置条件</a></li>
                <li>
                    <a href="#%e6%ad%a3%e5%bc%8f%e5%86%85%e5%ae%b9" aria-label="正式内容">正式内容</a><ul>
                        
                <li>
                    <a href="#%e4%b8%bb%e8%a6%81%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84" aria-label="主要数据结构">主要数据结构</a></li>
                <li>
                    <a href="#%e6%89%ab%e5%9d%97%e7%b3%bb%e7%bb%9f" aria-label="扫块系统">扫块系统</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

    <div class="post-content"><h2 id="前言">前言<a hidden class="anchor" aria-hidden="true" href="#前言">#</a></h2>
<p>对于某些网站平台如果想支持收取波场区块链,但是又不清楚完整的流程应该如何部署的话,这里可以提供一套较为完整的方案,实现如商城下支持对客户的在线支付,</p>
<h2 id="目标">目标<a hidden class="anchor" aria-hidden="true" href="#目标">#</a></h2>
<p>实现客户在线支付,收取波场链的usdt或usdc,并且自动支付和激活订单,最后能归集到一个账户上自由使用</p>
<h2 id="前置条件">前置条件<a hidden class="anchor" aria-hidden="true" href="#前置条件">#</a></h2>
<p>在波场链有足够的trx,数量的多少取决于你对于归集的效率的需求,如果需要归集的周期越短,效率越快,则需要的trx越多<br>
1个总钱包,其中会扩展的功能有,分发冻结能量,收款,激活钱包,也可以看业务需要拆开成3个钱包<br>
开发环境:  python  mysql</p>
<h2 id="正式内容">正式内容<a hidden class="anchor" aria-hidden="true" href="#正式内容">#</a></h2>
<p>所有的接口以及交互均来自 <a href="https://cn.developers.tron.network/">波场链官网文档</a> ,如果对于文档不太熟的同学请先阅读了解下波场链的交易流程</p>
<h3 id="主要数据结构">主要数据结构<a hidden class="anchor" aria-hidden="true" href="#主要数据结构">#</a></h3>
<blockquote>
<p>节点数据 block_chain_block</p>
</blockquote>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>bigint</td>
<td>区块节点</td>
</tr>
<tr>
<td>total</td>
<td>int</td>
<td>总交易数</td>
</tr>
<tr>
<td>active</td>
<td>int</td>
<td>已激活交易数</td>
</tr>
<tr>
<td>created_at</td>
<td>timestamp</td>
<td>创建时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>timestamp</td>
<td>更新时间</td>
</tr>
<tr>
<td>started_at</td>
<td>timestamp</td>
<td>开始执行时间</td>
</tr>
<tr>
<td>ended_at</td>
<td>timestamp</td>
<td>结束执行时间</td>
</tr>
<tr>
<td>block_at</td>
<td>timestamp</td>
<td>节点时间</td>
</tr>
<tr>
<td>error</td>
<td>timestamp</td>
<td>节点错误信息</td>
</tr>
</tbody>
</table>
<blockquote>
<p>钱包数据 block_chain_wallet</p>
</blockquote>
<table>
<thead>
<tr>
<th>数据类型</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>id</td>
<td>int</td>
<td>自增id</td>
</tr>
<tr>
<td>address</td>
<td>varchar(255)</td>
<td>地址</td>
</tr>
<tr>
<td>private_key</td>
<td>varchar(1024)</td>
<td>地址密钥(建议保存到数据库时加密)</td>
</tr>
<tr>
<td>user_id</td>
<td>int</td>
<td>客户用户ID</td>
</tr>
<tr>
<td>created_at</td>
<td>timestamp</td>
<td>创建时间</td>
</tr>
<tr>
<td>updated_at</td>
<td>timestamp</td>
<td>更新时间</td>
</tr>
<tr>
<td>deposit</td>
<td>decimal(30,6)</td>
<td>余额</td>
</tr>
<tr>
<td>status</td>
<td>varchar(16)</td>
<td>状态</td>
</tr>
</tbody>
</table>
<h3 id="扫块系统">扫块系统<a hidden class="anchor" aria-hidden="true" href="#扫块系统">#</a></h3>
<p>想要获取到链上所有的交易信息,主要有两种方式,第一自建超级节点服务器,这样就可以频繁获取数据而不受限制,但是对于一般的网站平台来说,搭建一台波场链节点服务器浪费了资金,因此这里采用第二种方式,通过官网提供的接口进行查询同步,需注意本文涉及用到的接口均是固块化API</p>
<ol>
<li>查询当前最新节点
<a href="https://cn.developers.tron.network/reference/getnowblock">文档</a> 通过接口获取到当前最新节点和本地已同步的节点比较,能知道当前程序同步的情况如何,如果存在&quot;追不上&quot;差值越来越大,可能需要增加线程处理等方式</li>
</ol>
<blockquote>
<p>接口: <a href="https://cn.developers.tron.network/reference/getnowblock">/walletsolidity/getnowblock</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;blockID&#34;</span><span class="p">:</span> <span class="s2">&#34;000000000198e6cee71c8e83366b925e64c5cf715529ac009bfbaff132e98d6b&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;block_header&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;raw_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;number&#34;</span><span class="p">:</span> <span class="mi">26797774</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;txTrieRoot&#34;</span><span class="p">:</span> <span class="s2">&#34;f5689c087055959a66ac7638e79c57319dffb84631992852791a3f47784b267e&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;witness_address&#34;</span><span class="p">:</span> <span class="s2">&#34;41d42e593de3cee8156934cc2182ef4d107e9291f0&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;parentHash&#34;</span><span class="p">:</span> <span class="s2">&#34;000000000198e6cde394799dcc330b00422a8cc028be767526e1f1500afcd682&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;version&#34;</span><span class="p">:</span> <span class="mi">24</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1660618479000</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;witness_signature&#34;</span><span class="p">:</span> <span class="s2">&#34;c4317733f65fe7a9f3d235f9037b903cb1e3c6b2192f4dce5a24930c92f0663167ed9dbbdb5c134692c107416d44a874d07fd62dc61fed4bde318eae3adf8f0300&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;transactions&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ret&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;contractRet&#34;</span><span class="p">:</span> <span class="s2">&#34;SUCCESS&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signature&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;fd0750453b2ae27ae02df417b724518ceac4fb432181f30dafddc2e73d83784768143ae9e12cb15816c9f852436f48303fd927aa3e6908cc9880ecf505fffe8300&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;txID&#34;</span><span class="p">:</span> <span class="s2">&#34;92e168626aa79ed3c307ce2030acf12aa92dcb6114f66b53a8243dba738ea720&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;raw_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;contract&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;parameter&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;amount&#34;</span><span class="p">:</span> <span class="mi">650</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;owner_address&#34;</span><span class="p">:</span> <span class="s2">&#34;411b51ed3f22cec14b4c53abb99c4f5bff1aa5b5d1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;to_address&#34;</span><span class="p">:</span> <span class="s2">&#34;41a7040c812f5e8188243bc781dfbcace984ec832b&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type_url&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/protocol.TransferContract&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;TransferContract&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ref_block_bytes&#34;</span><span class="p">:</span> <span class="s2">&#34;e6bb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ref_block_hash&#34;</span><span class="p">:</span> <span class="s2">&#34;2f39e8e056fb3672&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;expiration&#34;</span><span class="p">:</span> <span class="mi">1660618536000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1660618476362</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;raw_data_hex&#34;</span><span class="p">:</span> <span class="s2">&#34;0a02e6bb22082f39e8e056fb367240c0e8cfa4aa305a66080112620a2d747970652e676f6f676c65617069732e636f6d2f70726f746f636f6c2e5472616e73666572436f6e747261637412310a15411b51ed3f22cec14b4c53abb99c4f5bff1aa5b5d1121541a7040c812f5e8188243bc781dfbcace984ec832b188a0570ca96cca4aa30&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;ret&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="nt">&#34;contractRet&#34;</span><span class="p">:</span> <span class="s2">&#34;SUCCESS&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;signature&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;6fc213cc693d9aadf7941792e5ee35dd33203290428391be499e9ea1f9799febbc5265eea5ed342b5c006a8a9e7113bbc34ecf148005e32cd8ea127ecbd094a700&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;txID&#34;</span><span class="p">:</span> <span class="s2">&#34;48855473d1263692f6b8ce34c654996cdb05d89fcbd7c8eb152736fcd4c10bb7&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;raw_data&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;contract&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;parameter&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;value&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;amount&#34;</span><span class="p">:</span> <span class="mi">60500</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;owner_address&#34;</span><span class="p">:</span> <span class="s2">&#34;41b3dbb883203c53cdf3d7d85521ee8322c1d92125&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nt">&#34;to_address&#34;</span><span class="p">:</span> <span class="s2">&#34;41000e42c42d4d525eb291ef7374da28d3f251c9b0&#34;</span>
</span></span><span class="line"><span class="cl">              <span class="p">},</span>
</span></span><span class="line"><span class="cl">              <span class="nt">&#34;type_url&#34;</span><span class="p">:</span> <span class="s2">&#34;type.googleapis.com/protocol.TransferContract&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;TransferContract&#34;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ref_block_bytes&#34;</span><span class="p">:</span> <span class="s2">&#34;e6bb&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;ref_block_hash&#34;</span><span class="p">:</span> <span class="s2">&#34;2f39e8e056fb3672&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;expiration&#34;</span><span class="p">:</span> <span class="mi">1660618537006</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nt">&#34;timestamp&#34;</span><span class="p">:</span> <span class="mi">1660618477006</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="nt">&#34;raw_data_hex&#34;</span><span class="p">:</span> <span class="s2">&#34;0a02e6bb22082f39e8e056fb367240aef0cfa4aa305a67080112630a2d747970652e676f6f676c65617069732e636f6d2f70726f746f636f6c2e5472616e73666572436f6e747261637412320a1541b3dbb883203c53cdf3d7d85521ee8322c1d92125121541000e42c42d4d525eb291ef7374da28d3f251c9b018d4d80370ce9bcca4aa30&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>当前节点为 now_block_num = int(GetNowBlock.get(&lsquo;block_header&rsquo;).get(&lsquo;raw_data&rsquo;).get(&rsquo;number&rsquo;))</p>
<ol start="2">
<li>查询数据表中已同步最新的节点</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">block</span> <span class="o">=</span> session.query<span class="o">(</span>BlockChainBlock<span class="o">)</span>.order_by<span class="o">(</span>BlockChainBlock.id.desc<span class="o">())</span>.first<span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> block is None:
</span></span><span class="line"><span class="cl">  <span class="nv">blocksnum</span> <span class="o">=</span> now_block_num - <span class="m">95</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>:
</span></span><span class="line"><span class="cl">  <span class="nv">blocksnum</span> <span class="o">=</span> block.id + <span class="m">1</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl"><span class="k">if</span> blocksnum &gt; now_block_num:
</span></span><span class="line"><span class="cl">  print<span class="o">(</span><span class="s2">&#34;扫块速度过快超过波场出块,停歇一会&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">  time.sleep<span class="o">(</span>3<span class="o">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">continue</span>
</span></span></code></pre></div><ol start="3">
<li>每次按批查询一定节点的数据</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="nv">min_block_num</span> <span class="o">=</span> min<span class="o">(</span>blocksnum + 30, now_block_num<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> i in range<span class="o">(</span>blocksnum, min_block_num<span class="o">)</span>:
</span></span><span class="line"><span class="cl">  <span class="nv">block</span> <span class="o">=</span> session.query<span class="o">(</span>BlockChainBlock<span class="o">)</span>.filter<span class="o">(</span>BlockChainBlock.id <span class="o">==</span> i<span class="o">)</span>.first<span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> block is not None:
</span></span><span class="line"><span class="cl">      <span class="k">continue</span>
</span></span><span class="line"><span class="cl">  <span class="k">else</span>:
</span></span><span class="line"><span class="cl">      <span class="nv">block</span> <span class="o">=</span> BlockChainBlock<span class="o">(</span>
</span></span><span class="line"><span class="cl">          <span class="nv">id</span><span class="o">=</span>i,
</span></span><span class="line"><span class="cl">          <span class="nv">total</span><span class="o">=</span>0,
</span></span><span class="line"><span class="cl">          <span class="nv">active</span><span class="o">=</span>0,
</span></span><span class="line"><span class="cl">          <span class="nv">created_at</span><span class="o">=</span>datetime.datetime.now<span class="o">()</span>,
</span></span><span class="line"><span class="cl">          <span class="nv">updated_at</span><span class="o">=</span>datetime.datetime.now<span class="o">()</span>,
</span></span><span class="line"><span class="cl">      <span class="o">)</span>
</span></span><span class="line"><span class="cl">      session.add<span class="o">(</span>block<span class="o">)</span>
</span></span><span class="line"><span class="cl">      session.commit<span class="o">()</span>
</span></span><span class="line"><span class="cl">      <span class="nv">req</span> <span class="o">=</span> WorkRequest<span class="o">(</span>handleThread, <span class="nv">args</span><span class="o">=[</span>i, 1<span class="o">]</span>, <span class="nv">kwds</span><span class="o">={})</span>
</span></span><span class="line"><span class="cl">      main.putRequest<span class="o">(</span>req<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 将之前没同步到的区块重新查一下</span>
</span></span><span class="line"><span class="cl"><span class="nv">history_block_list</span> <span class="o">=</span> session.query<span class="o">(</span>BlockChainBlock<span class="o">)</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>        .filter<span class="o">(</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># BlockChainBlock.ended_at == None,</span>
</span></span><span class="line"><span class="cl">  BlockChainBlock.error <span class="o">==</span> <span class="s1">&#39;503 Service Temporarily Unavailable&#39;</span>,
</span></span><span class="line"><span class="cl">  BlockChainBlock.updated_at &lt;<span class="o">=</span>
</span></span><span class="line"><span class="cl">  <span class="o">(</span>datetime.datetime.now<span class="o">()</span> - datetime.timedelta<span class="o">(</span><span class="nv">minutes</span><span class="o">=</span>15<span class="o">))</span>.strftime<span class="o">(</span><span class="s2">&#34;%Y-%m-%d %H:%M:%S&#34;</span><span class="o">))</span> <span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span>  .all<span class="o">()</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> block in history_block_list:
</span></span><span class="line"><span class="cl">  block.updated_at <span class="o">=</span> datetime.datetime.now<span class="o">()</span>
</span></span><span class="line"><span class="cl">  session.add<span class="o">(</span>block<span class="o">)</span>
</span></span><span class="line"><span class="cl">  session.commit<span class="o">()</span>
</span></span><span class="line"><span class="cl">  <span class="nv">req</span> <span class="o">=</span> WorkRequest<span class="o">(</span>handleThread, <span class="nv">args</span><span class="o">=[</span>block.id, 1<span class="o">]</span>, <span class="nv">kwds</span><span class="o">={})</span>
</span></span><span class="line"><span class="cl">  main.putRequest<span class="o">(</span>req<span class="o">)</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">try:
</span></span><span class="line"><span class="cl">     <span class="c1"># 清理一下历史没问题的节点数据,释放数据库空间</span>
</span></span><span class="line"><span class="cl">     session.query<span class="o">(</span>BlockChainBlock<span class="o">)</span>.filter<span class="o">(</span>
</span></span><span class="line"><span class="cl">         BlockChainBlock.active <span class="o">==</span> 0,
</span></span><span class="line"><span class="cl">         <span class="c1"># BlockChainBlock.ended_at != None,</span>
</span></span><span class="line"><span class="cl">         BlockChainBlock.updated_at &lt;<span class="o">=</span>
</span></span><span class="line"><span class="cl">         <span class="o">(</span>datetime.datetime.now<span class="o">()</span> - datetime.timedelta<span class="o">(</span><span class="nv">hours</span><span class="o">=</span>6<span class="o">))</span>.strftime<span class="o">(</span><span class="s2">&#34;%Y-%m-%d %H:%M:%S&#34;</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">     <span class="o">)</span>.delete<span class="o">()</span>
</span></span><span class="line"><span class="cl">     session.commit<span class="o">()</span>
</span></span><span class="line"><span class="cl"> except Exception as e:
</span></span><span class="line"><span class="cl">     print<span class="o">(</span>e<span class="o">)</span>
</span></span><span class="line"><span class="cl">     pass
</span></span><span class="line"><span class="cl">     
</span></span><span class="line"><span class="cl"><span class="c1"># 如果当前最新需同步的区块较少的,可等待久点累积一下</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> min_block_num - blocksnum &lt; 5:
</span></span><span class="line"><span class="cl">  time.sleep<span class="o">(</span>10<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span>:
</span></span><span class="line"><span class="cl">  time.sleep<span class="o">(</span>1<span class="o">)</span>
</span></span></code></pre></div><ol start="4">
<li>处理节点数据,获取交易列表详情<br>
这段的代码比较多,基本来说就是获取每个节点下的交易数据,然后把每条交易数据进行解析,获取需要合约地址,金额,对象,时间,这样处理后扫块的流程基本就完结</li>
</ol>
<pre tabindex="0"><code>pool_engine = create_engine(config.SQLALCHEMY_DATABASE_URI, pool_size=10, max_overflow=10, pool_timeout=180)
PoolSession = sessionmaker(bind=pool_engine)

def handleThread(blocksnum, delay=0):
   trx = Trx(None)
   session = PoolSession()
   block = session.query(BlockChainBlock).filter(BlockChainBlock.id == blocksnum).first()
   #更新开始执行时间
   block.started_at = datetime.datetime.now()
   block.error = &#34;&#34;
   session.add(block)
   session.commit()
   try:
     #获取当前节点的全部交易数据
     transactionsData = trx.get_walletsolidity_block_by_num(block.id)
   except Exception as e:
     print(&#34;get_walletsolidity_block_by_num&#34;)
     print(e)
     block.error = &#34;503 Service Temporarily Unavailable&#34;
     block.ended_at = datetime.datetime.now()
     session.add(block)
     session.commit()
     session.close()
     return
   try:
     transaction_at = (transactionsData[&#39;block_header&#39;][&#39;raw_data&#39;][&#39;timestamp&#39;]) / 1000
     transaction_at = time.strftime(&#34;%Y-%m-%d %H:%M:%S&#34;, time.localtime(transaction_at))
   except Exception as e:
     print(e)
     block.error = &#34;not timestamp&#34;
     block.ended_at = datetime.datetime.now()
     session.add(block)
     session.commit()
     session.close()
     return
     
   if transactionsData.get(&#34;transactions&#34;) is None:
     block.error = &#34;not transactions&#34;
     block.ended_at = datetime.datetime.now()
     block.block_at = transaction_at
     session.add(block)
     session.commit()
     session.close()
     return
     
   block.block_at = transaction_at
   block.total = len(transactionsData[&#39;transactions&#39;])
   session.add(block)
   session.commit()
   active = 0
   exist_count = 0
   for transaction in transactionsData[&#39;transactions&#39;]:
      out_trade_no = transaction[&#39;txID&#39;]
      status = transaction[&#39;ret&#39;][0][&#39;contractRet&#39;].lower()
      if status != &#39;success&#39;:
         continue
      try:
         contract = transaction[&#39;raw_data&#39;][&#39;contract&#39;][0][&#39;parameter&#39;][&#39;value&#39;][&#39;contract_address&#39;]
         contract = keys.to_base58check_address(contract)
      except:
         continue
      #active_contract = None
      #for contract_address in config_contract.contract_address:
      #   if contract_address.get(&#34;address&#34;) == contract:
      #       active_contract = contract_address
      #       break
      #if active_contract is None:
      #   continue
      func = transaction[&#39;raw_data&#39;][&#34;contract&#34;][0][&#34;parameter&#34;][&#34;value&#34;][&#34;data&#34;][0:8]
      if func != &#34;a9059cbb&#34;:
         continue
      to_address = keys.to_base58check_address(
            transaction[&#39;raw_data&#39;][&#34;contract&#34;][0][&#34;parameter&#34;][&#34;value&#34;][&#34;data&#34;][9:72].lstrip(&#34;0&#34;))
      try:
         transactionAmount = int(
             transaction[&#39;raw_data&#39;][&#34;contract&#34;][0][&#34;parameter&#34;][&#34;value&#34;][&#34;data&#34;][72:].lstrip(&#34;0&#34;), 16) / 1000000
      except:
         continue
       # transaction_at 交易时间
       # contract 合约地址
       # to_address 收款地址
       # transactionAmount 收款金额
       # 实现自己的功能
   block.ended_at = datetime.datetime.now()
   block.doed_at = transaction_at
   block.active = active
   session.add(block)
   session.commit()
</code></pre><ol start="5">
<li>多线程处理 handleThread
节点之间的数据查询并不会影响,因此在处理节点数据handleThread的时候,可增加多线程来操作,加快扫块的效率</li>
</ol>
<p>本文主要讲述的是扫块的模块,还有冻结能量的模块另外再展开说明</p>


    </div>

    <footer class="post-footer">
        <ul class="post-tags">
            <li><a href="/tags/tronlink/">tronlink</a></li>
        </ul>
<nav class="paginav">
  <a class="prev" href="/tech/github-001/">
    <span class="title">« 上一页</span>
    <br>
    <span>Github-</span>
  </a>
  <a class="next" href="/tech/hugo-003/">
    <span class="title">下一页 »</span>
    <br>
    <span>从0到1 记录搭建Hugo个人博客-03 使用Algolia搜索</span>
  </a>
</nav>

    </footer>
</article>
<script src="https://giscus.app/client.js"
        data-repo="suguer/giscus.github.io"
        data-repo-id="R_kgDOH08FpA"
        data-category="Announcements"
        data-category-id="DIC_kwDOH08FpM4CQ2jj"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
    </main>
    
<footer class="footer">
    <span>&copy; 2022 <a href="/">Ken Blog</a></span>
    <span>
       Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <a href="http://beian.miit.gov.cn/" target="_blank">粤ICP备19150058号</a>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
